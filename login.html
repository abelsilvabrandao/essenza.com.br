<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="js/config.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Essenza</title>
  <link rel="stylesheet" href="css/style.css">
<!-- FontAwesome 6 para ícones do olho -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body.login-bg {
      min-height: 100vh;
      background: linear-gradient(135deg, #ffb6d5 0%, #ff69b4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .essenza-login-box {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 32px rgba(255,105,180,0.13);
      padding: 2.5rem 2rem 2.2rem 2rem;
      max-width: 370px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .essenza-login-title {
      font-family: 'Playfair Display', serif;
      color: #ff69b4;
      font-size: 2.1rem;
      font-weight: 700;
      margin-bottom: 0.8rem;
      letter-spacing: 2px;
      text-align: center;
    }
    .essenza-login-box label {
      width: 100%;
      color: #ff69b4;
      font-size: 1.08rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
      margin-top: 1.1rem;
    }
    .essenza-login-box input[type="email"],
    .essenza-login-box input[type="text"],
    .essenza-login-box input[type="password"],
    .essenza-login-box input[type="date"],
    .essenza-login-box input[type="tel"] {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1.5px solid #ffb6d5;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 0.9rem;
      outline: none;
      background: #fff;
      color: #8d3969;
      box-shadow: 0 2px 8px rgba(255,182,213,0.06);
      transition: border 0.2s, box-shadow 0.2s;
    }
    .essenza-login-box input[type="email"]:focus,
    .essenza-login-box input[type="text"]:focus,
    .essenza-login-box input[type="password"]:focus,
    .essenza-login-box input[type="date"]:focus,
    .essenza-login-box input[type="tel"]:focus {
      border-color: #ff69b4;
      box-shadow: 0 2px 12px rgba(255,105,180,0.10);
      background: #fff7fa;
    }
    .essenza-login-box label {
      width: 100%;
      color: #ff69b4;
      font-size: 1.08rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
      margin-top: 1.1rem;
      letter-spacing: 0.01em;
    }
    .essenza-login-box .forgot {
      color: #ff69b4;
      font-size: 0.96rem;
      text-align: left;
      width: 100%;
      margin-bottom: 1.1rem;
      margin-top: -0.5rem;
      cursor: pointer;
      text-decoration: underline;
    }
    .essenza-login-box button.login-btn {
      width: 100%;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 0.85rem 0;
      font-size: 1.13rem;
      font-weight: 600;
      margin-bottom: 1.2rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(255,105,180,0.13);
    }
    .essenza-login-box button.login-btn:hover,
    .essenza-login-box button.login-btn:focus {
      background: #ff4da6;
      transform: translateY(-2px);
    }
    .essenza-login-divider {
      width: 100%;
      border-bottom: 1.5px solid #ffe0f1;
      margin: 0.8rem 0 1.1rem 0;
      text-align: center;
      color: #ff69b4;
      font-size: 0.97rem;
      position: relative;
    }
    .essenza-login-divider span {
      background: #fff;
      position: relative;
      top: 0.7em;
      padding: 0 1em;
    }
    .essenza-login-google {
      width: 100%;
      border: 1.5px solid #ffb6d5;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      color: #ff69b4;
      font-weight: 500;
      font-size: 1.13rem;
      padding: 0.7rem 0;
      margin-bottom: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
      box-shadow: 0 2px 8px rgba(255,182,213,0.07);
    }
    .essenza-login-google:hover,
    .essenza-login-google:focus {
      background: #ffe0f1;
      border-color: #ff69b4;
    }
    .essenza-login-google img {
      height: 22px;
      margin-right: 0.9em;
    }
    .essenza-login-box .recaptcha {
      margin-top: 1.2rem;
      font-size: 0.85rem;
      color: #b8b8b8;
      text-align: center;
    }
    @media (max-width: 480px) {
      .essenza-login-box {
        padding: 1.2rem 0.4rem;
        max-width: 98vw;
      }
      .essenza-login-title {
        font-size: 1.45rem;
      }
    }
  </style>
</head>
<body class="login-bg">
  <div class="essenza-login-box" id="essenzaLoginBox">
    <div class="essenza-login-title">ESSENZA</div>
    <form id="formLogin" autocomplete="on">
      <label for="loginEmail">E-mail</label>
      <input type="email" id="loginEmail" name="email" placeholder="Email" required autocomplete="email">
      <button class="login-btn" id="btnContinuarEmail" type="button" style="margin-bottom:1.1em;">Continuar</button>
      <div id="loginPasswordArea" style="display:none;">
        <label for="loginPassword">Senha</label>
        <div class="password-input-wrap">
          <input type="password" id="loginPassword" name="password" placeholder="Senha" required autocomplete="current-password">
          <button type="button" id="toggleLoginPassword" tabindex="-1" aria-label="Mostrar ou ocultar senha">
            <i class="fa-solid fa-eye-slash"></i>
          </button>
        </div>
        <button class="login-btn" type="submit">Entrar</button>
        <div style="text-align:right;margin-top:0.3em;">
          <a href="#" id="showForgot" style="color:#ff69b4;text-decoration:underline;font-size:0.98em;">Recuperar senha</a>
        </div>
      </div>
    </form>
    <div class="essenza-login-divider"><span>ou</span></div>
    <button type="button" class="essenza-login-google" id="googleLoginBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="height:22px;margin-right:0.9em;">
      Entrar com Google
    </button>
    <form id="formRegister" style="display:none" autocomplete="on">
      <label for="registerEmail">Email*</label>
      <div style="display:flex;align-items:center;gap:6px;">
        <input type="email" id="registerEmail" name="email" placeholder="Email" required autocomplete="email" readonly style="flex:1; background:#f4f4f4; color:#888;">
        <button type="button" id="clearEmailBtn" title="Limpar e-mail" style="background:none;border:none;font-size:1.2em;color:#b8b8b8;cursor:pointer;display:none;"><i class="fas fa-times"></i></button>
      </div>
      <label for="registerName">Nome*</label>
      <input type="text" id="registerName" name="name" placeholder="Nome" required autocomplete="given-name">
      <label for="registerSurname">Sobrenome*</label>
      <input type="text" id="registerSurname" name="surname" placeholder="Sobrenome" required autocomplete="family-name">
      <label for="registerCPF">CPF*</label>
      <input type="text" id="registerCPF" name="cpf" placeholder="CPF" required maxlength="14" autocomplete="off">
      <label for="registerBirth">Data de Nascimento*</label>
      <input type="date" id="registerBirth" name="birth" required>
      <label for="registerPhone">Celular*</label>
      <input type="tel" id="registerPhone" name="phone" placeholder="(99) 99999-9999" required maxlength="16" autocomplete="tel">
      <label for="registerPassword">Senha*</label>
      <div class="password-input-wrap">
        <input type="password" id="registerPassword" name="password" placeholder="Senha" required autocomplete="new-password">
        <button type="button" id="toggleRegisterPassword" tabindex="-1" aria-label="Mostrar ou ocultar senha">
          <i class="fas fa-eye-slash"></i>
        </button>
      </div>
      <div id="registerPasswordError" style="display:none;"></div>
      <div id="passwordRules" style="background:#faf7fd;border:1px solid #eee;border-radius:8px;padding:0.7em 1em;margin:0.7em 0 1em 0;font-size:0.97em;color:#555;">
        <div id="ruleSpecial"><i class="fas fa-times" style="color:#ff69b4"></i> Mínimo um caractere especial (Ex.: "@" "/" "!" "%")</div>
        <div id="ruleNumber"><i class="fas fa-times" style="color:#ff69b4"></i> Mínimo um número</div>
        <div id="ruleUpper"><i class="fas fa-times" style="color:#ff69b4"></i> Mínimo uma letra maiúscula</div>
        <div id="ruleLower"><i class="fas fa-times" style="color:#ff69b4"></i> Mínimo uma letra minúscula</div>
        <div id="ruleLength"><i class="fas fa-times" style="color:#ff69b4"></i> Mínimo 6 caracteres</div>
      </div>
      <div style="margin-bottom:0.6em;">
        <div style="margin-bottom:0.3em;">Com qual gênero você se identifica?</div>
        <label style="margin-right:1.1em;"><input type="radio" name="gender" value="Feminino" required> Feminino</label>
        <label><input type="radio" name="gender" value="Masculino" required> Masculino</label>
      </div>
      <div style="font-size:0.91em;color:#888;margin-bottom:0.7em;">Ao se cadastrar, você receberá comunicações por email com ofertas especiais e vantagens. Saiba mais acessando nossa <a href="#" style="color:#ff69b4;text-decoration:underline;">Política de Privacidade</a>.</div>
      <button class="login-btn" type="submit" style="background:#8f4be9;">Criar Conta</button>
    </form>
    <form id="formForgot" style="display:none">
      <label for="forgotEmail">Digite seu e-mail para redefinir a senha</label>
      <input type="email" id="forgotEmail" name="email" placeholder="Email" required autocomplete="email">
      <button class="login-btn" type="submit">Enviar link</button>
    </form>

    <div class="recaptcha">Protegido por reCAPTCHA • Privacidade</div>
    <div id="loginMsg" style="margin-top:0.7rem;width:100%;text-align:center;font-size:1.05em;color:#ff69b4;"></div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup, updateProfile, fetchSignInMethodsForEmail } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';
    const firebaseConfig = window.firebaseConfig || {
      apiKey: "SUA_API_KEY",
      authDomain: "SUA_AUTH_DOMAIN",
      projectId: "SUA_PROJECT_ID",
      storageBucket: "SUA_STORAGE_BUCKET",
      messagingSenderId: "SUA_MESSAGING_SENDER_ID",
      appId: "SUA_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);
    // Alternância de abas
    // const tabLogin = document.getElementById('tabLogin');
    // const tabRegister = document.getElementById('tabRegister');
    // const tabForgot = document.getElementById('tabForgot');
    const formLogin = document.getElementById('formLogin');
    const formRegister = document.getElementById('formRegister');
    const formForgot = document.getElementById('formForgot');
    const loginMsg = document.getElementById('loginMsg');
    // --- FLUXO INTELIGENTE LOGIN/CADASTRO POR E-MAIL ---
    const loginEmail = document.getElementById('loginEmail');
    const btnContinuarEmail = document.getElementById('btnContinuarEmail');
    const loginPasswordArea = document.getElementById('loginPasswordArea');
    const registerEmail = document.getElementById('registerEmail');
    const googleBtn = document.getElementById('googleLoginBtn');
const googleDivider = document.querySelector('.essenza-login-divider');

if (btnContinuarEmail && loginEmail && loginPasswordArea && formRegister && registerEmail && googleBtn && googleDivider) {
      btnContinuarEmail.onclick = async function(ev) {
        ev.preventDefault();
        loginMsg.textContent = '';
        const email = loginEmail.value.trim().toLowerCase();
        if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          loginMsg.style.color = '#ff69b4';
          loginMsg.textContent = 'Digite um e-mail válido.';
          return;
        }
        btnContinuarEmail.disabled = true;
        btnContinuarEmail.textContent = 'Verificando...';
        try {
          const methods = await fetchSignInMethodsForEmail(auth, email);
          console.log('Métodos de login encontrados:', methods);
          if (methods.includes('password')) {
            // Exibir campo de senha apenas se o método password estiver presente
            loginPasswordArea.style.display = '';
            loginEmail.readOnly = true;
            btnContinuarEmail.style.display = 'none';
            formRegister.style.display = 'none';
            formLogin.style.display = '';
          } else if (methods.includes('google.com')) {
            // Mensagem para login Google
            loginMsg.style.color = '#ff69b4';
            loginMsg.textContent = 'Este e-mail utiliza login com o Google. Use o botão do Google.';
          } else {
            // Usuário não existe: mostrar cadastro
            formLogin.style.display = 'none';
            formRegister.style.display = '';
            registerEmail.value = email;
            registerEmail.readOnly = true;
            const clearBtn = document.getElementById('clearEmailBtn');
            if (clearBtn) clearBtn.style.display = '';
            if (googleBtn) googleBtn.style.display = 'none';
            if (googleDivider) googleDivider.style.display = 'none';
          }
        } catch (err) {
          loginMsg.style.color = '#ff69b4';
          loginMsg.textContent = 'Erro ao verificar e-mail. Tente novamente.';
        } finally {
          btnContinuarEmail.disabled = false;
          btnContinuarEmail.textContent = 'Continuar';
        }
      };
      // Botão limpar e-mail no cadastro
      const clearBtn = document.getElementById('clearEmailBtn');
      if (clearBtn) {
        clearBtn.onclick = function() {
          formRegister.style.display = 'none';
          formLogin.style.display = '';
          loginEmail.value = '';
          loginEmail.readOnly = false;
          btnContinuarEmail.style.display = '';
          loginPasswordArea.style.display = 'none';
          loginMsg.textContent = '';
          // Restaura Google
          if (googleBtn) googleBtn.style.display = '';
          if (googleDivider) googleDivider.style.display = '';
        }
      }
    }
    // --- FIM FLUXO INTELIGENTE ---
    function showTab(tab) {
      formLogin.style.display = tab === 'login' ? '' : 'none';
      formRegister.style.display = tab === 'register' ? '' : 'none';
      formForgot.style.display = tab === 'forgot' ? '' : 'none';
      tabLogin.setAttribute('aria-selected', tab === 'login');
      tabRegister.setAttribute('aria-selected', tab === 'register');
      tabForgot.setAttribute('aria-selected', tab === 'forgot');
      loginMsg.textContent = '';
    }
    // tabLogin.onclick = () => showTab('login');
    // tabRegister.onclick = () => showTab('register');
    // tabForgot.onclick = () => showTab('forgot');
    // Mostrar/ocultar senha login
window.addEventListener('DOMContentLoaded', function() {
  const toggleLoginPassword = document.getElementById('toggleLoginPassword');
  const loginPassword = document.getElementById('loginPassword');
  if(toggleLoginPassword && loginPassword) {
    toggleLoginPassword.onclick = function(e) {
      e.preventDefault();
      const icon = toggleLoginPassword.querySelector('i');
      if(loginPassword.type === 'password') {
        loginPassword.type = 'text';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        toggleLoginPassword.classList.add('active');
      } else {
        loginPassword.type = 'password';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        toggleLoginPassword.classList.remove('active');
      }
    };
  }
  // Máscara CPF
  const cpfInput = document.getElementById('registerCPF');
  if (cpfInput) {
    cpfInput.addEventListener('input', function(e) {
      let v = cpfInput.value.replace(/\D/g, '').slice(0,11);
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
      v = v.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
      cpfInput.value = v;
    });
    cpfInput.addEventListener('blur', function() {
      const cpf = cpfInput.value.replace(/\D/g, '');
      if (cpf.length === 11 && !validaCPF(cpf)) {
        cpfInput.setCustomValidity('CPF inválido');
        cpfInput.reportValidity();
      } else {
        cpfInput.setCustomValidity('');
      }
    });
  }
  // Máscara Data de Nascimento
  const birthInput = document.getElementById('registerBirth');
  if (birthInput) {
    birthInput.setAttribute('type', 'text');
    birthInput.setAttribute('maxlength', '10');
    birthInput.addEventListener('input', function(e) {
      let v = birthInput.value.replace(/\D/g, '').slice(0,8);
      if (v.length > 4) v = v.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
      else if (v.length > 2) v = v.replace(/(\d{2})(\d{1,2})/, '$1/$2');
      birthInput.value = v;
    });
  }
  // Máscara Telefone
  const phoneInput = document.getElementById('registerPhone');

  // Mostrar/ocultar senha cadastro
  const toggleRegisterPassword = document.getElementById('toggleRegisterPassword');
  const registerPassword = document.getElementById('registerPassword');
  if (toggleRegisterPassword && registerPassword) {
    toggleRegisterPassword.onclick = function(e) {
      e.preventDefault();
      const icon = toggleRegisterPassword.querySelector('i');
      if (registerPassword.type === 'password') {
        registerPassword.type = 'text';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        toggleRegisterPassword.classList.add('active');
      } else {
        registerPassword.type = 'password';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        toggleRegisterPassword.classList.remove('active');
      }
    };
  }

  // Validação de complexidade da senha em tempo real
  if (registerPassword) {
    // Elemento de erro já existe no HTML
    const passwordError = document.getElementById('registerPasswordError');
    passwordError.style.color = '#d32f2f';
    passwordError.style.fontSize = '0.54em';
    passwordError.style.marginTop = '-0.4em';
    passwordError.style.marginBottom = '0.6em';
    passwordError.style.display = 'none';
    passwordError.style.alignItems = 'center';
    passwordError.style.gap = '0.4em';
    passwordError.innerHTML = '<i class="fa-solid fa-circle-exclamation" style="margin-right:0.5em;"></i> A senha deve cumprir as regras a seguir.';
    registerPassword.classList.remove('input-error');

    const rules = {
      special: /[!@#$%^&*(),.?":{}|<>\/\\]/,
      number: /\d/,
      upper: /[A-Z]/,
      lower: /[a-z]/,
      length: /.{6,}/
    };
    const ruleIds = {
      special: 'ruleSpecial',
      number: 'ruleNumber',
      upper: 'ruleUpper',
      lower: 'ruleLower',
      length: 'ruleLength'
    };
    registerPassword.addEventListener('input', function() {
      // Remove erro visual ao digitar
      registerPassword.classList.remove('input-error');
      passwordError.style.display = 'none';
      const val = registerPassword.value;
      let allValid = true;
      for (const rule in rules) {
        const ok = rules[rule].test(val);
        const ruleDiv = document.getElementById(ruleIds[rule]);
        if (ruleDiv) {
          ruleDiv.querySelector('i').className = ok ? 'fas fa-check' : 'fas fa-times';
          ruleDiv.querySelector('i').style.color = ok ? '#3ec486' : '#ff69b4';
        }
        if (!ok) allValid = false;
      }
      if (!allValid) {
        registerPassword.setCustomValidity('A senha não atende todos os requisitos.');
        registerPassword.classList.add('input-error');
        passwordError.style.display = 'flex';
      } else {
        registerPassword.setCustomValidity('');
        registerPassword.classList.remove('input-error');
        passwordError.style.display = 'none';
      }
    });
  }
  if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
      let v = phoneInput.value.replace(/\D/g, '').slice(0,11);
      if (v.length > 6) v = v.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
      else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
      else v = v.replace(/(\d{0,2})/, '($1');
      phoneInput.value = v.trim();
    });
  }
  // Função de validação de CPF
  function validaCPF(strCPF) {
    let sum = 0;
    let rest;
    if (strCPF == "00000000000") return false;
    for (let i=1; i<=9; i++) sum = sum + parseInt(strCPF.substring(i-1, i)) * (11 - i);
    rest = (sum * 10) % 11;
    if ((rest == 10) || (rest == 11))  rest = 0;
    if (rest != parseInt(strCPF.substring(9, 10)) ) return false;
    sum = 0;
    for (let i = 1; i <= 10; i++) sum = sum + parseInt(strCPF.substring(i-1, i)) * (12 - i);
    rest = (sum * 10) % 11;
    if ((rest == 10) || (rest == 11))  rest = 0;
    if (rest != parseInt(strCPF.substring(10, 11) ) ) return false;
    return true;
  }
});
// Login
    formLogin.onsubmit = async (e) => {
  // Se o campo de senha não está visível, aciona o fluxo do botão 'Continuar' do e-mail
  const loginPasswordArea = document.getElementById('loginPasswordArea');
  if (loginPasswordArea && loginPasswordArea.style.display === 'none') {
    e.preventDefault();
    const btnContinuarEmail = document.getElementById('btnContinuarEmail');
    if (btnContinuarEmail) btnContinuarEmail.click();
    return;
  }

      e.preventDefault();
      loginMsg.textContent = '';
      const email = formLogin.loginEmail.value;
      const password = formLogin.loginPassword.value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;
        // Buscar dados do cliente na coleção 'clientes' usando o UID
        let clienteDoc = null;
        let clienteData = null;
        // Busca por UID (campo 'uid' nos docs, pois ID do doc é o CPF)
        const q = query(collection(db, 'clientes'), where('uid', '==', uid));
        const snap = await getDocs(q);
        if (!snap.empty) {
          clienteDoc = snap.docs[0];
          clienteData = clienteDoc.data();
        } else {
          // Fallback: buscar por e-mail
          const qEmail = query(collection(db, 'clientes'), where('email', '==', email));
          const snapEmail = await getDocs(qEmail);
          if (!snapEmail.empty) {
            clienteDoc = snapEmail.docs[0];
            clienteData = clienteDoc.data();
          }
        }
        if (clienteData) {
          // Salva dados completos no localStorage
          localStorage.setItem('essenzaUser', JSON.stringify({
            email: clienteData.email,
            name: clienteData.nome,
            uid: clienteData.uid,
            cpf: clienteData.cpf,
            sobrenome: clienteData.sobrenome,
            celular: clienteData.celular,
            genero: clienteData.genero,
            dataNascimento: clienteData.dataNascimento
          }));
          loginMsg.style.color = '#3ec486';
          loginMsg.textContent = 'Login realizado com sucesso! Redirecionando...';
          setTimeout(() => { window.location.href = '/'; }, 1200);
        } else {
          // Usuário autenticado mas não achou cliente no Firestore
          loginMsg.style.color = '#ff69b4';
          loginMsg.textContent = 'Login realizado, mas não encontramos seus dados de cliente. Por favor, entre em contato com o suporte.';
        }
      } catch (e) {
        loginMsg.style.color = '#ff69b4';
        loginMsg.textContent = 'Erro: ' + (e.code === 'auth/wrong-password' ? 'Senha incorreta.' : e.code === 'auth/user-not-found' ? 'Usuário não encontrado.' : e.message);
      }
    };
    // Cadastro
    formRegister.onsubmit = async (e) => {
      e.preventDefault();
      loginMsg.textContent = '';
      // Se veio do Google, usar dados do Google + campos preenchidos
      if (window.essenzaGoogleUser) {
        const user = window.essenzaGoogleUser;
        const cpf = formRegister.registerCPF.value.replace(/\D/g, '');
        if (!cpf || !/^\d{11}$/.test(cpf)) {
          loginMsg.style.color = '#ff69b4';
          loginMsg.textContent = 'CPF inválido ou não informado.';
          return;
        }
        // Verifica se já existe cadastro com este CPF
        const cpfDoc = await getDoc(doc(db, 'clientes', cpf));
        if (cpfDoc.exists()) {
          loginMsg.style.color = '#ff69b4';
          loginMsg.textContent = 'Já existe um cadastro com este CPF. Faça login normalmente.';
          return;
        }
        // Salva cadastro do cliente
        await setDoc(doc(db, 'clientes', cpf), {
        cpf: cpf,
        uid: user.uid,
        email: user.email,
        nome: formRegister.registerName.value,
        sobrenome: formRegister.registerSurname.value,
        celular: formRegister.registerPhone.value,
        genero: formRegister.gender.value,
        dataNascimento: formRegister.registerBirth.value,
        favoritos: [],
        pedidos: []
        });
        localStorage.setItem('essenzaUser', JSON.stringify({email: user.email, name: user.displayName, uid: user.uid, cpf}));
        loginMsg.style.color = '#3ec486';
        loginMsg.textContent = 'Cadastro realizado com sucesso! Redirecionando...';
        setTimeout(() => { window.location.href = '/'; }, 1200);
        return;
      }
      // Fluxo normal (email/senha)
      const name = formRegister.registerName.value;
      const email = formRegister.registerEmail.value;
      const password = formRegister.registerPassword.value;
      const cpf = formRegister.registerCPF.value.replace(/\D/g, '');
      if (!cpf || !/^\d{11}$/.test(cpf)) {
        loginMsg.style.color = '#ff69b4';
        loginMsg.textContent = 'CPF inválido ou não informado.';
        return;
      }
      // Verifica se já existe cadastro com este CPF
      const cpfDoc = await getDoc(doc(db, 'clientes', cpf));
      if (cpfDoc.exists()) {
        loginMsg.style.color = '#ff69b4';
        loginMsg.textContent = 'Já existe um cadastro com este CPF. Faça login normalmente.';
        return;
      }
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCred.user, { displayName: name });
        // Usa diretamente userCred.user para criar o documento do cliente
        await setDoc(doc(db, 'clientes', cpf), {
          cpf: cpf,
          uid: userCred.user.uid,
          email: userCred.user.email,
          nome: name,
          sobrenome: formRegister.registerSurname.value,
          celular: formRegister.registerPhone.value,
          genero: formRegister.gender.value,
          dataNascimento: formRegister.registerBirth.value,
          favoritos: [],
          pedidos: []
        });
        localStorage.setItem('essenzaUser', JSON.stringify({email: userCred.user.email, name, uid: userCred.user.uid, cpf}));
        loginMsg.style.color = '#3ec486';
        loginMsg.textContent = 'Cadastro realizado com sucesso! Redirecionando...';
        setTimeout(() => { window.location.href = '/'; }, 1200);
      } catch (e) {
        console.error('Erro no cadastro:', e);
        loginMsg.style.color = '#ff69b4';
        loginMsg.textContent = 'Erro: ' + (e.code === 'auth/email-already-in-use' ? 'E-mail já cadastrado.' : e.message);
      }
    };
    // Recuperação de senha
    formForgot.onsubmit = async (e) => {
      e.preventDefault();
      loginMsg.textContent = '';
      const email = formForgot.forgotEmail.value;
      try {
        await sendPasswordResetEmail(auth, email);
        loginMsg.style.color = '#3ec486';
        loginMsg.textContent = 'E-mail de recuperação enviado!';
      } catch (e) {
        loginMsg.style.color = '#ff69b4';
        loginMsg.textContent = 'Erro: ' + (e.code === 'auth/user-not-found' ? 'E-mail não cadastrado.' : e.message);
      }
    };
    // Google
    window.addEventListener('DOMContentLoaded', function() {
      const googleBtn = document.getElementById('googleLoginBtn');
      console.log('Botão Google encontrado?', googleBtn);
      if (googleBtn) {
        googleBtn.onclick = async () => {
          loginMsg.textContent = '';
          try {
            const userCred = await signInWithPopup(auth, provider);
            const user = userCred.user;
            // Buscar cliente pelo UID vinculado
            let cpf = '';
            let clienteDoc = null;
            const clientesRef = collection(db, 'clientes');
            const q = query(clientesRef, where('uid', '==', user.uid));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
              // Cliente já cadastrado
              clienteDoc = querySnapshot.docs[0];
              localStorage.setItem('essenzaUser', JSON.stringify({email: user.email, name: user.displayName, uid: user.uid, cpf: clienteDoc.id}));
              loginMsg.style.color = '#3ec486';
              loginMsg.textContent = 'Login realizado com sucesso! Redirecionando...';
              setTimeout(() => { window.location.href = '/'; }, 1200);
              return;
            }
            // Se não encontrou, abrir tela de cadastro completa
            // Preencher nome, sobrenome e email no formRegister
            document.getElementById('formLogin').style.display = 'none';
            document.getElementById('formRegister').style.display = '';
            // Esconde botão Google e divisor 'ou'
            document.getElementById('googleLoginBtn').style.display = 'none';
            const divider = document.querySelector('.essenza-login-divider');
            if (divider) divider.style.display = 'none';
            // Preenche campos
            document.getElementById('registerEmail').value = user.email;
            document.getElementById('registerName').value = (user.displayName || '').split(' ')[0] || '';
            document.getElementById('registerSurname').value = (user.displayName || '').split(' ').slice(1).join(' ');
            // Foca no campo CPF
            document.getElementById('registerCPF').focus();
            // Corrige estilos dos inputs (remove background e cor customizada)
            document.getElementById('registerEmail').style.background = '';
            document.getElementById('registerEmail').style.color = '';
            // Salva dados Google temporariamente para uso no cadastro
            window.essenzaGoogleUser = user;
            loginMsg.style.color = '#3ec486';
            loginMsg.textContent = 'Complete seu cadastro para finalizar o acesso.';
          } catch (e) {
            if (e.code !== 'auth/popup-closed-by-user') {
              loginMsg.style.color = '#ff69b4';
              loginMsg.textContent = 'Erro ao logar com Google: ' + e.message;
            }
          }
        };
      }
    });
    // Atalho: Enter em qualquer campo envia o formulário correto
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (formLogin.style.display !== 'none' && document.activeElement.form === formLogin) formLogin.requestSubmit();
        if (formRegister.style.display !== 'none' && document.activeElement.form === formRegister) formRegister.requestSubmit();
        if (formForgot.style.display !== 'none' && document.activeElement.form === formForgot) formForgot.requestSubmit();
      }
    });
  </script>
</body>
</html>
