<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- FontAwesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Essenza - Venda Express</title>
  <style>
    :root{
      --bg:#0e0f12;         /* fundo escuro elegante */
      --card:#151821;       /* cartões */
      --muted:#252a36;      /* bordas/inputs */
      --text:#e8ecf2;       /* texto principal */
      --sub:#a7b0c3;        /* texto secundário */
      --brand:#6dd17c;      /* destaque/CTA */
      --danger:#ff6363;     /* remover/erro */
      --warn:#ffb86b;       /* alerta */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; color:var(--text);
      background:linear-gradient(180deg,#0b0c10, #0e0f12 8%, #0e0f12);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      background:rgba(14,15,18,.75); border-bottom:1px solid var(--muted);
    }
    .container{padding:16px; max-width:900px; margin:0 auto}
    .row{display:flex; gap:12px}
    .col{flex:1}
    h1{font-size:20px; margin:10px 0}

    /* Busca */
    .search-card{background:var(--card); border:1px solid var(--muted); padding:12px; border-radius:14px}
    .search-wrap{display:flex; gap:8px}
    .input{flex:1; background:#0f1116; color:var(--text); border:1px solid var(--muted); border-radius:12px; padding:14px 12px; outline:none}
    .input::placeholder{color:#7d879a}
    .btn{appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:600; cursor:pointer}
    .btn-brand{background:var(--brand); color:#0a0d10}
    .btn-ghost{background:#0f1116; color:var(--text); border:1px solid var(--muted)}
    .btn-danger{background:var(--danger); color:#0a0d10}
    .btn-sm{padding:8px 10px; border-radius:10px; font-size:14px}

    /* Lista de produtos */
    .list{margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height:38vh; overflow:auto}
    .item{display:flex; gap:10px; align-items:center; background:#10131a; border:1px solid var(--muted); padding:10px; border-radius:12px}
    .avatar{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#2f3544,#3c4356); display:grid; place-items:center; font-weight:700; color:#dfe7ff}
    .item .meta{flex:1}
    .item .title{font-size:15px; font-weight:700}
    .item .sub{font-size:12px; color:var(--sub)}
    .price{font-weight:800}

    /* Carrinho */
    .card{background:var(--card); border:1px solid var(--muted); padding:12px; border-radius:14px}
    .cart-list{display:flex; flex-direction:column; gap:8px; max-height:26vh; overflow:auto}
    .cart-row{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; background:#10131a; border:1px solid var(--muted); border-radius:12px; padding:10px}
    .qty{display:flex; align-items:center; gap:6px}
    .qty .btn{width:34px; height:34px}
    .qty input{width:54px; text-align:center; padding:8px; border-radius:10px; border:1px solid var(--muted); background:#0f1116; color:var(--text)}
    .line-right{display:flex; align-items:center; gap:8px}

    /* Cliente & Pagamento */
    .form{display:grid; gap:8px}
    label{font-size:12px; color:var(--sub)}
    .row-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--muted); padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none}
    .chip.active{background:var(--brand); color:#0a0d10; border-color:transparent}

    /* Barra fixa */
    .bar{position:fixed; left:0; right:0; bottom:0; background:rgba(15,16,20,.95); border-top:1px solid var(--muted); padding:12px; z-index:20}
    .bar .inner{max-width:900px; margin:0 auto; display:flex; gap:10px; align-items:center}
    .total{font-size:18px; font-weight:800; margin-right:auto}

    /* Toast/Modal simples */
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:80px; background:#111520; border:1px solid var(--muted); padding:12px 14px; border-radius:12px; display:none; z-index:30}

    /* Espaço inferior para não ficar atrás da barra */
    .spacer{height:96px}

    @media(min-width:720px){
      .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
      .list{max-height:50vh}
      .cart-list{max-height:32vh}
    }
    /* Mensagens de cupom */
    .coupon-feedback{white-space:pre-line}
    .coupon-feedback .coupon-plus{display:block;text-align:center;opacity:.8;margin:2px 0}
  </style>
  <link rel="icon" type="image/png" href="logo-light.png" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/png" href="logo-dark.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <header>
    <div class="container">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="img/logo.png" alt="Logo Essenza" style="height:42px; width:auto; filter: drop-shadow(0 1px 2px #0002);">
        <h1 style="margin:0; font-family: 'Playfair Display', serif; font-weight:600; letter-spacing:1px; font-size:2.1rem; color:#f3e8e2; text-shadow:0 1px 6px #0006;">ESSENZA</h1>
        <span style="margin-left:18px; font-size:1.23rem; font-family:'Poppins',sans-serif; font-style:italic; font-weight:700; letter-spacing:1px; background:linear-gradient(90deg,#6dd17c,#5eead4 70%,#fff 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 2px 8px #0005,0 1px 0 #6dd17c80; filter:brightness(1.15);">Express</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- BUSCA / PRODUTOS -->
    <section class="search-card">
      <div class="search-wrap">
        <input id="q" class="input" placeholder="Buscar por nome, código..." autocomplete="off" />
        <button id="clearFilter" class="btn btn-ghost" type="button">Limpar Filtro</button>
      </div>
      <div style="display:flex;gap:8px;margin:10px 0 0 0;align-items:center;flex-wrap:wrap">
        <select id="categoryFilter" class="input" style="max-width:180px;"></select>
        <select id="orderFilter" class="input" style="max-width:180px;">
          <option value="default">Ordenar por</option>
          <option value="price-asc">Menor preço</option>
          <option value="price-desc">Maior preço</option>
        </select>
      </div>
      <div id="results" class="list" aria-live="polite"></div>
    </section>

    <div class="grid" style="margin-top:12px">
      <!-- CARRINHO -->
      <section class="card">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
          <strong>Carrinho</strong>
          <span id="cartCount" class="sub"></span>
        </div>
        <div id="cartList" class="cart-list" aria-live="polite"></div>
      </section>

      <!-- CLIENTE / PAGAMENTO -->
      <section class="card">
        <strong style="display:block; margin-bottom:6px">Cliente & Pagamento</strong>
        <form id="orderForm" class="form" autocomplete="off">
          <div>
            <label for="nome">Nome completo *</label>
            <input id="nome" class="input" required placeholder="Ex: Maria Silva" />
          </div>
          <div class="row-2">
            <div>
              <label for="cel">Celular (com DDD) *</label>
              <input id="cel" class="input" required inputmode="tel" placeholder="(11) 90000-0000" />
            </div>
            <div>
              <label for="email">E-mail (opcional)</label>
              <input id="email" class="input" type="email" placeholder="email@exemplo.com" />
            </div>
          </div>

          <div>
            <label for="couponInput">Cupom de desconto</label>
            <div style="display:flex; gap:0.5em; align-items:center; margin-bottom:0.3em;">
              <input type="text" id="couponInput" class="input" placeholder="Cupom de desconto" style="flex:1;max-width:170px;">
              <button type="button" id="clearCouponBtn" style="display:none;margin-left:-32px;background:transparent;border:none;color:#888;font-size:1.2rem;cursor:pointer;align-self:center;" aria-label="Limpar cupom">&times;</button>
              <button type="button" id="applyCouponBtn" class="btn btn-ghost btn-sm">Aplicar</button>
            </div>
            <div id="couponFeedback" class="coupon-feedback" style="margin-bottom:0.7em;"></div>
          </div>

          <div>
            <label>Forma de pagamento</label>
            <div id="payChips" class="chips" style="gap:0.7em;">
              <label class="chip payment-option">
                <input type="radio" name="paymentMethod" id="paymentMethodPix" value="pix" checked style="display:none;">
                <span><i class="fas fa-bolt"></i> Pix <span class="discount-badge" id="pixDiscountBadge" style="font-size:11px; margin-left:2px;">-10%</span></span>
              </label>
              <label class="chip payment-option">
                <input type="radio" name="paymentMethod" id="paymentMethodCartão" value="cartao" style="display:none;">
                <span><i class="fas fa-credit-card"></i> Cartão</span>
              </label>
              <label class="chip payment-option" id="acordoChip" style="display:none;">
                <input type="radio" name="paymentMethod" id="paymentMethodAgreement" value="agreement" style="display:none;">
                <span><i class="fas fa-file-signature"></i> Acordo</span>
              </label>
            </div>
          </div>

          <div id="installmentsWrap" style="display:none;">
            <label for="installments">Parcelar em:</label>
            <select id="installments" class="input"></select>
            <div id="installmentInfo" style="color:#a7b0c3;font-size:13px;margin-top:2px;"></div>
          </div>

                  </form>
      </section>
    </div>

    <div class="spacer"></div>
  </main>

  <!-- BARRA FIXA -->
  <div class="bar">
    <div class="inner">
      <div class="total">Total: <span id="total">R$ 0,00</span></div>
      <button id="shareWA" class="btn btn-ghost btn-sm" title="Compartilhar no WhatsApp">Compartilhar</button>
      <button id="finish" class="btn btn-brand">Encerrar Pedido</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/vendas-feedback.js"></script>
  <script type="module">
    import { getCouponByCode } from './js/coupons-client.js';

    // Definição da chave de armazenamento dos pedidos
    const STORAGE_ORDERS = 'vendas_orders';
    let appliedCoupon = null;
    const couponInput = document.getElementById('couponInput');
    const applyCouponBtn = document.getElementById('applyCouponBtn');
    const clearCouponBtn = document.getElementById('clearCouponBtn');
    const couponFeedback = document.getElementById('couponFeedback');
    const acordoChip = document.getElementById('acordoChip');

    function updateClearCouponBtn() {
      if (couponInput.value.trim()) {
        clearCouponBtn.style.display = '';
      } else {
        clearCouponBtn.style.display = 'none';
      }
    }

    async function handleCoupon() {
      const code = couponInput.value.trim().toUpperCase();
      appliedCoupon = null;
      couponFeedback.textContent = '';
      couponFeedback.className = 'coupon-feedback';
      if (code) {
        const coupon = await getCouponByCode(code);
        if (coupon) {
          // Validação de datas
          let valid = true;
          let errorMsg = '';
          let errorIsHTML = false;
          const today = new Date();
          if (!coupon.noExpiration) {
            if (coupon.startDate && today < new Date(coupon.startDate)) {
              valid = false;
              errorMsg = 'Cupom ainda não está ativo.';
            }
            if (coupon.endDate && today > new Date(coupon.endDate)) {
              valid = false;
              errorMsg = 'Cupom expirado.';
            }
          }
          // Validação de produtos obrigatórios (ex.: PAR15)
          if (valid && Array.isArray(coupon.productIds) && coupon.productIds.length > 0) {
            const cartIds = Array.isArray(cart) ? cart.map(it => String(it.id)) : [];
            const allProductsPresent = coupon.productIds.every(pid => cartIds.includes(String(pid)));
            if (!allProductsPresent) {
              valid = false;
              // Montar lista nominal dos produtos exigidos (mostrar apenas os que faltam)
              const missing = coupon.productIds.filter(pid => !cartIds.includes(String(pid)));
              const lines = missing.map((pid, idx) => {
                const prod = (Array.isArray(products) ? products : []).find(p => String(p.id) === String(pid));
                const name = prod?.nome || prod?.name || `Produto ${pid}`;
                const size = prod?.tamanho || prod?.size ? ` (${prod.tamanho || prod.size})` : '';
                return `1 - ${name}${size}`;
              });
              const formatted = lines.map((line, idx) => idx === 0 ? `<span>${line}</span>` : `<span class="coupon-plus">+</span><span>${line}</span>`).join('<br>');
              errorMsg = `Para usar este cupom, inclua no carrinho:<br>${formatted}`;
              errorIsHTML = true;
            }
          }
          if (valid) {
            appliedCoupon = coupon;
            localStorage.setItem('vendas_coupon', code);
            couponInput.classList.remove('input-error');
            couponInput.classList.add('input-success');
            // Mensagem de feedback incluindo restrições (em múltiplas linhas)
            const pm = Array.isArray(coupon.allowedPaymentMethods) ? coupon.allowedPaymentMethods : [];
            const pmMap = { pix: 'PIX', credit: 'Cartão', agreement: 'Acordo' };
            const lines = [coupon.description || 'Cupom aplicado com sucesso!'];
            if (pm.length === 1) {
              const label = pmMap[pm[0]] || pm[0];
              lines.push(`Válido apenas para pagamento ${label}`);
            } else if (pm.length > 1) {
              lines.push(`Válido para: ${pm.map(k => pmMap[k] || k).join(', ')}`);
            }
            if (Array.isArray(coupon.productIds) && coupon.productIds.length > 0) {
              lines.push('Aplicável a produtos específicos.');
            }
            if (Number.isInteger(coupon.progressiveMultiple) && coupon.progressiveMultiple >= 2) {
              lines.push(`Desconto progressivo a cada ${coupon.progressiveMultiple} un. elegíveis.`);
            }
            couponFeedback.textContent = lines.join('\n');
            couponFeedback.className = 'coupon-feedback feedback-success';
            // Mostrar chip Acordo se cupom requer/permite acordo
            const allowsAgreement = (pm.length ? pm.includes('agreement') : !!coupon.enableAgreement);
            if (allowsAgreement && acordoChip) {
              acordoChip.style.display = '';
            } else if (acordoChip) {
              acordoChip.style.display = 'none';
            }
          } else {
            appliedCoupon = null;
            localStorage.removeItem('vendas_coupon');
            couponInput.classList.remove('input-success');
            couponInput.classList.add('input-error');
            if (typeof errorIsHTML !== 'undefined' && errorIsHTML) {
              couponFeedback.innerHTML = errorMsg;
            } else {
              couponFeedback.textContent = errorMsg;
            }
            couponFeedback.className = 'coupon-feedback feedback-error';
            if (acordoChip) acordoChip.style.display = 'none';
          }
        } else {
          appliedCoupon = null;
          localStorage.removeItem('vendas_coupon');
          couponInput.classList.remove('input-success');
          couponInput.classList.add('input-error');
          couponFeedback.textContent = 'O cupom informado não existe ou está incorreto.';
          couponFeedback.className = 'coupon-feedback feedback-error';
          if (acordoChip) acordoChip.style.display = 'none';
        }
      } else {
        appliedCoupon = null;
        localStorage.removeItem('vendas_coupon');
        couponInput.classList.remove('input-success','input-error');
        couponFeedback.textContent = '';
        couponFeedback.className = 'coupon-feedback';
        if (acordoChip) acordoChip.style.display = 'none';
      }
      renderPayChips();
      renderCart();
      updateInstallmentInfo();
    }

    applyCouponBtn.addEventListener('click', handleCoupon);
    couponInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleCoupon();
      }
    });
    couponInput.addEventListener('input', updateClearCouponBtn);
    clearCouponBtn.addEventListener('click', () => {
      couponInput.value = '';
      couponInput.classList.remove('input-success', 'input-error');
      appliedCoupon = null;
      updateClearCouponBtn();
      if (acordoChip) acordoChip.style.display = 'none';
      localStorage.removeItem('vendas_coupon');
      couponFeedback.textContent = '';
      couponFeedback.className = 'coupon-feedback';
      renderPayChips();
      renderCart();
      updateInstallmentInfo();
    });
    updateClearCouponBtn();
    // Restaurar cupom salvo
    try {
      const savedCoupon = localStorage.getItem('vendas_coupon');
      if (savedCoupon && couponInput) {
        couponInput.value = savedCoupon;
        handleCoupon();
      }
    } catch{}

    // Expor para integração com renderPayChips
    window.getAppliedCoupon = () => appliedCoupon;
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
    import { getFirestore, runTransaction, doc, collection, arrayUnion, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';
    // Inicializar Firebase e Firestore para uso dos módulos ES6
    const firebaseConfig = {
      apiKey: "AIzaSyAxwRPEkFUE_rudNjKT7xrg5lSLfTHUe-g",
      authDomain: "siteabel-4bcca.firebaseapp.com",
      projectId: "siteabel-4bcca",
      storageBucket: "siteabel-4bcca.appspot.com",
      messagingSenderId: "865433569180",
      appId: "1:865433569180:web:2ad4d6391ad2432b25aa59",
      measurementId: "G-PDFHYJ6YZK"
    };
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.runTransaction = runTransaction;
    window.doc = doc;
    window.collection = collection;
    window.arrayUnion = arrayUnion;
    window.serverTimestamp = serverTimestamp;

    // ===================== UTILS =====================
    const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatBRL = (n)=> BRL.format(n || 0);
    const parseBRL = (s)=>{
      if(!s) return 0; // aceita 0
      // converte "1.234,56" -> 1234.56
      const only = String(s).replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(',','.');
      const n = parseFloat(only);
      return isNaN(n) ? 0 : n;
    };
    const el = (sel)=> document.querySelector(sel);
    const uid = ()=> 'P'+Date.now().toString(36)+Math.random().toString(36).slice(2,6).toUpperCase();

    // ===================== FIRESTORE INTEGRATION =====================
    import { loadProducts, baixarEstoque, salvarPedidoFirestore } from './js/vendas-firestore.js';
    let products = [];
window.products = products; // Expor para patch
let cart = [];
window.cart = cart; // Expor para patch
window.formaSelecionada = window.formaSelecionada || 'Pix';
let formaSelecionada = window.formaSelecionada;
    // Carregar produtos reais ao iniciar
    async function carregarProdutosExpress() {
  products = await loadProducts();
  window.products = products;
  // Preencher filtro de categoria
  const catSel = document.getElementById('categoryFilter');
  if (catSel) {
    const categorias = Array.from(new Set(products.map(p => p.categoria||p.category||'Sem categoria')));
    catSel.innerHTML = `<option value='all'>Todas as categorias</option>` + categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    catSel.addEventListener('change', ()=> renderList(document.getElementById('q').value));
  }
  const orderSel = document.getElementById('orderFilter');
  if(orderSel) orderSel.addEventListener('change', ()=> renderList(document.getElementById('q').value));
  renderList('');
}

window.addEventListener('DOMContentLoaded', carregarProdutosExpress);
// Fallback: tenta carregar produtos após 1s se não houver nenhum carregado
setTimeout(() => {
  if (!window.products || window.products.length === 0) {
    carregarProdutosExpress();
  }
}, 1000);

    function saveProducts(list){ localStorage.setItem(STORAGE_PRODUCTS, JSON.stringify(list)); }

    function loadOrders(){
      const saved = localStorage.getItem(STORAGE_ORDERS);
      return saved ? JSON.parse(saved) : [];
    }
    function saveOrders(list){ localStorage.setItem(STORAGE_ORDERS, JSON.stringify(list)); }

    // products já é carregado de Firestore acima
    // cart = [] já definido acima

    // ===================== RENDER BUSCA =====================
    const results = el('#results');
    function initials(name){
      const parts = name.split(' ').filter(Boolean);
      const a = parts[0]?.[0]||''; const b = parts[1]?.[0]||'';
      return (a+b).toUpperCase() || 'PR';
    }
    function renderList(q=''){
      q = q.trim().toLowerCase();
      results.innerHTML = '';
      // --- Filtro categoria ---
      const catSel = el('#categoryFilter');
      const orderSel = el('#orderFilter');
      let categoria = catSel && catSel.value !== 'all' ? catSel.value : null;
      let order = orderSel ? orderSel.value : 'default';
      let items = products.filter(p=> {
        const nome = p.nome || p.name || '';
        const matchNome = !q || nome.toLowerCase().includes(q) || (p.codigo||'').toLowerCase().includes(q) || (p.id||'').includes(q);
        const cat = p.categoria || p.category || 'Sem categoria';
        const matchCat = !categoria || cat === categoria;
        return matchNome && matchCat;
      });
      // --- Ordenação ---
      if(order==='price-asc') items.sort((a,b)=>(a.preco||a.price||0)-(b.preco||b.price||0));
      if(order==='price-desc') items.sort((a,b)=>(b.preco||b.price||0)-(a.preco||a.price||0));
      if(items.length===0){
        results.innerHTML = `
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:180px;">
    <img src='img/logo.png' alt='Logo Essenza' style='width:70px;height:70px;animation:spinX 2.5s linear infinite;'/>
    <span style='margin-top:18px;font-size:1.2em;color:#fff;font-weight:500;'>Carregando...</span>
    <style>
      @keyframes spinX {
        0% { transform: rotateY(0deg); }
        100% { transform: rotateY(360deg); }
      }
    </style>
  </div>
`;
        return;
      }
      for(const p of items){
        const row = document.createElement('div');
        row.className = 'item';
        const nome = p.nome || p.name || '';
        const cat = p.categoria || p.category || '';
        row.innerHTML = `
          <div class="avatar" style="padding:0">
            ${p.imageUrl ? `<img src="${p.imageUrl}" alt="${nome}" style="width:44px;height:44px;object-fit:cover;border-radius:10px;">` : initials(nome)}
          </div>
          <div class="meta">
            <div class="title">${nome}</div>
            ${cat ? `<div class="categoria" style="color:#5eead4;font-size:13px;font-weight:500;margin-bottom:2px;">${cat}</div>` : ''}
            ${(() => {
  if (!p.descricao) return '';
  const matches = [...p.descricao.matchAll(/\*\*(.*?)\*\*/g)];
  if (!matches.length) return '';
  return `<div class='desc' style='color:#e8ecf2;font-size:13px;margin-top:2px;'>${matches.map(m => m[1]).join(' • ')}</div>`;
})()}

            <div class="sub">Código: ${p.id} • Estoque: <strong>${p.estoque}</strong> 
  ${(() => {
    const itemNoCarrinho = cart.find(x => x.id === p.id);
    const disponivel = Math.max(0, p.estoque - (itemNoCarrinho ? itemNoCarrinho.qty : 0));
    if (disponivel <= 0) return `<span class='estoque-badge' style='background:var(--danger);color:#fff;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:600;margin-left:8px;'>Produto Indisponível!</span>`;
    if (disponivel === 1) return `<span class='estoque-badge' style='background:var(--warn);color:#222;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:600;margin-left:8px;'>Última unidade!</span>`;
    if (disponivel === 2) return `<span class='estoque-badge' style='background:var(--warn);color:#222;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:600;margin-left:8px;'>Apenas 2 unidades!</span>`;
    return '';
  })()}
</div>
          </div>
          <div class="price" style="display:flex;flex-direction:column;align-items:flex-end;min-width:120px;">
            ${p.oldPrice && p.oldPrice > p.preco ? `<span style='color:#a7b0c3;text-decoration:line-through;font-size:13px;'>${formatBRL(p.oldPrice)}</span>` : ''}
            <span style='font-weight:800;font-size:17px;'>${formatBRL(p.preco)}</span>
            ${p.precoPix && p.precoPix < p.preco ? `<span style='color:#6dd17c;font-size:13px;'>PIX ${formatBRL(p.precoPix)}</span>` : ''}
          </div>
          <button class="btn btn-brand btn-sm">+</button>
        `;
        const btn = row.querySelector('button');
        btn.addEventListener('click', ()=> addToCart(p.id));
        results.appendChild(row);
      }
    }

    // ===================== CARRINHO =====================
    function addToCart(id){
      const p = products.find(x=>x.id===id);
      if(!p) return;
      if(p.estoque<=0){ toast('Produto sem estoque'); return; }
      const item = cart.find(x=>x.id===id);
      if(item){
        if(item.qty+1 > p.estoque){ toast('Quantidade excede o estoque'); return; }
        item.qty++;
      } else {
        cart.push({id:p.id, nome:p.nome, preco:p.preco, precoPix:p.precoPix, qty:1});
      }
      window.cart = cart;
      renderCart();
    }

    function removeFromCart(id){
      cart = cart.filter(x=>x.id!==id);
      window.cart = cart;
      renderCart();
    }

    function setQty(id, qty){
      qty = Math.max(1, Math.floor(qty||1));
      const p = products.find(x=>x.id===id);
      const item = cart.find(x=>x.id===id);
      if(!item || !p) return;
      if(qty > p.estoque){ toast('Quantidade excede o estoque'); return; }
      item.qty = qty;
window.cart = cart;
renderCart();
    }

    function getItemPrice(p) {
      let price = p.preco;
      if (formaSelecionada === 'Pix') price = p.precoPix && p.precoPix < p.preco ? p.precoPix : p.preco;
      // Acordo: usar preço normal
      // Descontos do cupom serão aplicados no total em cartTotal(),
      // para suportar regras por produto, progressivo e fixo corretamente.
      return price;
    }
    function cartTotal(){
      // Base sem cupom
      const baseTotal = cart.reduce((s,x)=> {
        const p = products.find(prod=>prod.id===x.id);
        return s + (p ? getItemPrice(p) * x.qty : 0);
      }, 0);
      if (!appliedCoupon) return baseTotal;
      const c = appliedCoupon;
      // Soma elegível quando cupom restringe por produto
      const eligibleSum = cart.reduce((sum, x) => {
        const p = products.find(prod=>prod.id===x.id);
        if (!p) return sum;
        const eligible = Array.isArray(c.productIds) && c.productIds.length > 0 ? c.productIds.some(pid => String(pid) === String(p.id)) : true;
        if (!eligible) return sum;
        return sum + (getItemPrice(p) * x.qty);
      }, 0);
      // Exigir todos os produtos obrigatórios presentes para o desconto (alinha com site principal)
      if (Array.isArray(c.productIds) && c.productIds.length > 0) {
        const cartIds = Array.isArray(cart) ? cart.map(it => String(it.id)) : [];
        const allProductsPresent = c.productIds.every(pid => cartIds.includes(String(pid)));
        if (!allProductsPresent) return baseTotal;
      }
      let discount = 0;
      const hasProgressive = Number.isInteger(c.progressiveMultiple) && c.progressiveMultiple >= 2 && Array.isArray(c.productIds) && c.productIds.length > 0;
      if (hasProgressive) {
        const M = c.progressiveMultiple;
        if (c.type === 'fixed') {
          // Quando M é igual à quantidade de produtos obrigatórios, formar PARES pelo mínimo das quantidades
          let discountPairs = 0; // número de pares efetivamente descontados
          if (Array.isArray(c.productIds) && c.productIds.length > 0 && M === c.productIds.length) {
            const qtys = c.productIds.map(pid => {
              const cartItem = cart.find(it => String(it.id) === String(pid));
              return Number(cartItem?.qty) || 0;
            });
            const pairs = qtys.length ? Math.min(...qtys) : 0; // pares possíveis (1 de cada)
            discountPairs = Math.min(pairs, M); // desconta no máximo M pares
          } else {
            // Fallback: total elegível dividido por M
            const totalEligibleQty = cart.reduce((q, item) => {
              const p = products.find(prod => prod.id === item.id);
              if (!p) return q;
              const eligible = c.productIds.some(pid => String(pid) === String(p.id));
              return eligible ? q + (Number(item.qty) || 0) : q;
            }, 0);
            const possiblePairs = Math.floor(totalEligibleQty / M);
            discountPairs = Math.min(possiblePairs, M);
          }
          if (discountPairs > 0) discount += c.value * discountPairs;
        } else {
          // Percentual permanece por item para evitar mudanças não previstas
          cart.forEach(item => {
            const p = products.find(prod => prod.id === item.id);
            if (!p) return;
            const eligible = c.productIds.some(pid => String(pid) === String(p.id));
            if (!eligible) return;
            const multiples = Math.floor((Number(item.qty) || 0) / M);
            if (multiples <= 0) return;
            const unit = getItemPrice(p);
            discount += unit * M * (c.value / 100) * multiples;
          });
        }
      } else {
        if (c.type === 'percent') {
          // Percentual sobre itens elegíveis (ou todos caso não restrinja)
          discount = eligibleSum * (c.value / 100);
        } else if (c.type === 'fixed') {
          // Desconto fixo limitado ao subtotal elegível
          discount = Math.min(c.value, eligibleSum);
        }
      }
      const final = Math.max(0, baseTotal - Math.round(discount));
      return final;
    }

    function renderCart(){
      const list = el('#cartList');
      list.innerHTML = '';
      el('#cartCount').textContent = cart.length ? `(${cart.length} item${cart.length>1?'s':''})` : '(vazio)';
      if (cart.length === 0) {
        list.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 0 18px 0;">
          <img src='img/carrinhovazio.png' alt='Carrinho vazio' style='width:110px;max-width:40vw;margin-bottom:14px;'>
          <div style='color:var(--brand);font-size:1.45rem;font-weight:700;letter-spacing:1px;text-align:center;'>CARRINHO VAZIO</div>
        </div>`;
        el('#total').textContent = formatBRL(0);
        return;
      }
      for(const it of cart){
        const p = products.find(x=>x.id===it.id);
        const valor = p ? getItemPrice(p) : it.preco;
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${it.nome}</div>
            <div class="sub">${formatBRL(valor)} • Estoque: ${p?.estoque ?? 0}</div>
          </div>
          <div class="line-right">
            <div class="qty">
              <button class="btn btn-ghost" aria-label="Diminuir">−</button>
              <input value="${it.qty}" aria-label="Quantidade" />
              <button class="btn btn-ghost" aria-label="Aumentar">+</button>
            </div>
            <div style="width:90px; text-align:right; font-weight:800">${formatBRL(valor * it.qty)}</div>
            <button class="btn btn-danger" title="Remover">✕</button>
          </div>
        `;
        const [btnMenos, inputQty, btnMais] = row.querySelectorAll('.qty > *');
        const btnRem = row.querySelector('.btn-danger');
        btnMenos.addEventListener('click', ()=> setQty(it.id, it.qty-1));
        btnMais.addEventListener('click', ()=> setQty(it.id, it.qty+1));
        inputQty.addEventListener('change', (e)=> setQty(it.id, parseInt(e.target.value,10)||1));
        btnRem.addEventListener('click', ()=> removeFromCart(it.id));
        list.appendChild(row);
      }
      el('#total').textContent = formatBRL(cartTotal());
    }

    // ===================== PAGAMENTO =====================
    // Formas de pagamento dinâmicas: 'Acordo' só aparece se cupom permitir acordo
    function getFormasPagamento() {
      const c = window.getAppliedCoupon ? window.getAppliedCoupon() : null;
      const map = { pix: 'Pix', credit: 'Cartão', agreement: 'Acordo' };
      if (c && Array.isArray(c.allowedPaymentMethods) && c.allowedPaymentMethods.length) {
        return c.allowedPaymentMethods.map(k => map[k]).filter(Boolean);
      }
      // Fallback à flag enableAgreement
      if (c && c.enableAgreement) return ['Pix', 'Cartão', 'Acordo'];
      return ['Pix', 'Cartão'];
    }
    
    function renderPayChips(opts={}){
  const wrap = el('#payChips');
  wrap.innerHTML = '';
  const formas = getFormasPagamento();
  if (!formas.includes(formaSelecionada)) formaSelecionada = formas[0] || 'Pix';
  for(const f of formas){
    const chip = document.createElement('div');
    chip.className = 'chip'+(f===formaSelecionada?' active':'');
    if(f === 'Pix') {
      // Calcular desconto Pix dinâmico
      let pixPercent = '';
      if (Array.isArray(cart) && cart.length > 0) {
        let total = 0, pixTotal = 0;
        for (const it of cart) {
          const p = products.find(x => x.id === it.id);
          if (p) {
            const normal = Number(p.preco) * it.qty;
            const pix = (p.precoPix && p.precoPix < p.preco ? Number(p.precoPix) : Number(p.preco)) * it.qty;
            total += normal;
            pixTotal += pix;
          }
        }
        if (total > 0 && pixTotal < total) {
          const percent = Math.round(((total - pixTotal) / total) * 100);
          if (percent > 0) pixPercent = `-${percent}%`;
        }
      }
      chip.innerHTML = `<i class="fas fa-bolt"></i> Pix <span class="discount-badge" id="pixDiscountBadge" style="font-size:11px; margin-left:2px;">${pixPercent || ''}</span>`;
    } else if(f === 'Cartão') {
      chip.innerHTML = '<i class="fas fa-credit-card"></i> Cartão';
    } else if(f === 'Acordo') {
      chip.innerHTML = '<i class="fas fa-file-signature"></i> Acordo';
    } else {
      chip.textContent = f;
    }
    chip.tabIndex = 0;
    chip.addEventListener('click', () => {
  formaSelecionada = f;
window.formaSelecionada = f;
window.cart = cart;
window.products = products;
renderPayChips({skipCart:true});
renderCart();
updateInstallmentInfo();
renderList(el('#q').value);
});
    chip.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); chip.click(); }});
    wrap.appendChild(chip);
  }
  if (window.updateAcordoVisibility) window.updateAcordoVisibility();
  if (window.renderPayChips) window.renderPayChips();
  if(!opts.skipCart) renderCart();
}

    

    // ===================== TOAST =====================
    let toastTimer;
    function toast(text){
      const t = el('#toast');
      t.textContent = text;
      t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.display='none'; }, 2600);
    }

    // ===================== EVENTOS =====================
    el('#q').addEventListener('input', e=> renderList(e.target.value));
    // O botão #finish agora é controlado pelo vendas-feedback.js (window.finalize)
    // Não adicionar event listener duplicado aqui.
        el('#shareWA').addEventListener('click', ()=>{
      const orders = loadOrders();
      const last = orders[orders.length-1];
      if(!last){ toast('Nenhum pedido para compartilhar'); return; }
      shareWhatsApp(last);
    });
    // Limpar filtro de busca
    el('#clearFilter').addEventListener('click', ()=>{
      el('#q').value = '';
      renderList('');
    });

    // ===================== PARCELAMENTO =====================
    function showInstallments(show) {
      el('#installmentsWrap').style.display = show ? '' : 'none';
    }
    function calculateInstallment(total, installments) {
      return total / installments;
    }
    function updateInstallmentOptions() {
  const select = el('#installments');
  if (!select) return;
  let opts = [];
  if (formaSelecionada === 'Cartão') {
    opts = [1,2,3];
  } else if (formaSelecionada === 'Acordo') {
    opts = [1,2];
  } else {
    opts = [1];
  }
  select.innerHTML = opts.map(v => `<option value="${v}">${v}x sem juros</option>`).join('');
  select.value = '1';
  renderCart(); // Atualiza o valor total imediatamente ao trocar forma de pagamento
  updateInstallmentInfo(); // Atualiza info de parcelas
}
    function updateInstallmentInfo() {
      const select = el('#installments');
      if (!select) return;
      const val = parseInt(select.value);
      let total = cartTotal();
      if (isNaN(total) || total <= 0) { el('#installmentInfo').textContent = ''; return; }
      const parcela = calculateInstallment(total, val);
      el('#installmentInfo').textContent = `${val}x de ${formatBRL(parcela)} sem juros`;
    }
    if (el('#installments')) {
  // Inicializa global ao carregar
  window.selectedInstallments = parseInt(el('#installments').value) || 1;
  el('#installments').addEventListener('change', () => {
    window.selectedInstallments = parseInt(el('#installments').value) || 1;
    updateInstallmentInfo();
    renderCart(); // Para atualizar total parcelado
  });
}

    // =========== INTEGRAÇÃO COM FORMA DE PAGAMENTO ==========
    // Supondo que já existe a variável formaSelecionada e função renderPayChips
    const oldRenderPayChips = renderPayChips;
    renderPayChips = function() {
      oldRenderPayChips();
      showInstallments(formaSelecionada === 'Cartão' || formaSelecionada === 'Acordo');
      updateInstallmentOptions();
      updateInstallmentInfo();
    }
    // Atualizar também ao trocar forma de pagamento
    document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('chip')) {
        setTimeout(()=>{
          showInstallments(formaSelecionada === 'Cartão' || formaSelecionada === 'Acordo');
          updateInstallmentOptions();
          updateInstallmentInfo();
        }, 50);
      }
    });
    // Inicialização
    updateInstallmentOptions();

    // =========== ATUALIZAR O TOTAL CONFORME PARCELAMENTO ==========
    const oldCartTotal = cartTotal;
    cartTotal = function() {
      if (formaSelecionada === 'Cartão' && el('#installments')) {
        const val = parseInt(el('#installments').value);
        let total = oldCartTotal();
        if (val > 6) {
          // Com juros
          return calculateInstallment(total, val) * val;
        }
        return total;
      }
      return oldCartTotal();
    }

    // ===================== INIT =====================
    renderList('');
    renderCart();
    renderPayChips();

    // --- INTEGRAÇÃO FINALIZAÇÃO DE PEDIDO (patch vendas-feedback.js) ---
  </script>
  <script type="module">
    import { maskPhone, validateClienteForm } from './js/vendas-clientes.js';
    const form = document.getElementById('orderForm');
    const nome = document.getElementById('nome');
    const cel = document.getElementById('cel');
    const email = document.getElementById('email');
    if (cel) maskPhone(cel);
    if (form) validateClienteForm(form);

    // Autocomplete visual para domínios de e-mail
    if (email) {
      const domains = ['gmail.com', 'hotmail.com', 'outlook.com', 'yahoo.com.br', 'uol.com.br'];
      const dropdown = document.createElement('div');
      dropdown.style.position = 'absolute';
      dropdown.style.background = '#181b23';
      dropdown.style.border = '1px solid #23242f';
      dropdown.style.borderRadius = '8px';
      dropdown.style.boxShadow = '0 2px 8px #0002';
      dropdown.style.zIndex = '100';
      dropdown.style.display = 'none';
      dropdown.style.minWidth = email.offsetWidth + 'px';
      dropdown.className = 'email-autocomplete-dropdown';
      email.parentNode.style.position = 'relative';
      email.parentNode.appendChild(dropdown);

      let currentFocus = -1;
      function closeDropdown() {
        dropdown.style.display = 'none';
        dropdown.innerHTML = '';
        currentFocus = -1;
      }
      function showDropdown(suggestions) {
        dropdown.innerHTML = '';
        suggestions.forEach((domain, idx) => {
          const item = document.createElement('div');
          item.textContent = email.value.split('@')[0] + '@' + domain;
          item.style.padding = '8px 12px';
          item.style.cursor = 'pointer';
          item.onmousedown = function(e) {
            e.preventDefault();
            email.value = item.textContent;
            closeDropdown();
            email.dispatchEvent(new Event('input'));
          };
          if (idx === currentFocus) {
            item.style.background = '#23242f';
            item.style.color = '#18c964';
          }
          dropdown.appendChild(item);
        });
        dropdown.style.display = suggestions.length ? 'block' : 'none';
      }
      email.addEventListener('input', function(e) {
        const val = email.value;
        const atIdx = val.indexOf('@');
        if (atIdx === -1) {
          closeDropdown();
          return;
        }
        const typedDomain = val.slice(atIdx + 1).toLowerCase();
        const filtered = domains.filter(d => d.startsWith(typedDomain));
        if (filtered.length) {
          showDropdown(filtered);
        } else {
          closeDropdown();
        }
      });
      email.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('div');
        if (!dropdown.style.display || dropdown.style.display === 'none') return;
        if (e.key === 'ArrowDown') {
          currentFocus = (currentFocus + 1) % items.length;
          showDropdown(Array.from(items).map(i => i.textContent.split('@')[1]));
          e.preventDefault();
        } else if (e.key === 'ArrowUp') {
          currentFocus = (currentFocus - 1 + items.length) % items.length;
          showDropdown(Array.from(items).map(i => i.textContent.split('@')[1]));
          e.preventDefault();
        } else if (e.key === 'Enter') {
          if (currentFocus > -1 && items[currentFocus]) {
            items[currentFocus].dispatchEvent(new MouseEvent('mousedown'));
            e.preventDefault();
          }
        } else if (e.key === 'Escape') {
          closeDropdown();
        }
      });
      email.addEventListener('blur', function() {
        setTimeout(closeDropdown, 150);
      });
    }
  </script>
</body>
</html>