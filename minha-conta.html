<!DOCTYPE html>
<html lang="pt-br">
<head>
<link rel="icon" href="logo-light.png" media="(prefers-color-scheme: light)">
<link rel="icon" href="logo-dark.png" media="(prefers-color-scheme: dark)">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Conta | Essenza</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/minha-conta-mobile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore-compat.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .account-box {
      max-width: 480px;
      margin: 3.5rem auto 2rem auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 16px #ff69b41a;
      padding: 2.2rem 2.2rem 1.2rem 2.2rem;
      font-family: 'Poppins', sans-serif;
    }
    .account-title {
      font-family: 'Playfair Display', serif;
      color: #8f4be9;
      font-size: 2.1rem;
      font-weight: 700;
      margin-bottom: 0.8em;
      text-align: center;
    }
    .account-section {
      margin-bottom: 1.5em;
    }
    .account-label {
      color: #b8b8b8;
      font-size: 0.97em;
      margin-bottom: 0.1em;
      display: block;
    }
    .account-value {
      color: #444;
      font-size: 1.13em;
      margin-bottom: 0.5em;
      font-weight: 500;
    }
    .account-actions {
      display: flex;
      gap: 1.3em;
      justify-content: flex-end;
      margin-top: 1.5em;
    }
    .account-action-btn {
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.7em 1.3em;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.18s;
    }
    .account-action-btn.logout {
      background: #b8b8b8;
    }
    @media (max-width: 600px) {
      .account-box {
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
      }
    }
  </style>
</head>
<body style="background:#faf7fd;">
  <header style="background:transparent;padding:1.2em 0 0.4em 0;margin-bottom:0.2em;">
    <div style="display:flex;flex-direction:column;align-items:center;gap:0.5em;">
      <div style="display:flex;align-items:center;gap:1em;justify-content:center;">
        <span style="font-family:'Poppins',sans-serif;font-size:1.45em;color:#222;">Sua conta</span>
        <img src="img/logo.png" alt="Essenza" style="height:2.1em;vertical-align:middle;">
        <span style="font-family:'Playfair Display',serif;font-size:2em;color:#222;">ESSENZA</span>
      </div>
    </div>
  </header>
  <div class="account-tabs" style="display:flex;justify-content:center;gap:1.1em;margin-top:0.7em;margin-bottom:2.2em;">
    <button class="account-tab-btn" id="tabDadosBtn">Meus Dados</button>
    <button class="account-tab-btn" id="tabPedidosBtn">Meus Pedidos</button>
    <button class="account-tab-btn" id="tabFavoritosBtn">Favoritos</button>
  </div>
  <div style="max-width:980px;margin:1.2em auto 0 auto;display:flex;justify-content:flex-start;">
  <a href="index.html" class="btn-voltar-loja" style="display:inline-flex;align-items:center;gap:0.7em;background:#f3e5f5;color:#7b1fa2;font-weight:700;font-size:1.08em;padding:0.65em 1.4em;border-radius:8px;text-decoration:none;box-shadow:0 2px 8px #0001;transition:background 0.18s;">
    <i class="fa fa-arrow-left"></i> Voltar à loja
  </a>
</div>
<main>
    <section id="sectionDados" class="account-section">
      <h2 style="font-family:'Poppins',sans-serif;color:#ff69b4;font-size:2.1em;font-weight:700;margin-bottom:0.7em;text-align:center;">Dados Pessoais</h2>
      <div class="account-data-box" style="background:#fff;border-radius:12px;box-shadow:0 2px 16px #ff69b41a;padding:1.3em 2em 1.1em 1.1em;display:flex;align-items:center;gap:1.5em;justify-content:space-between;max-width:980px;margin-bottom:2em;">
  <span id="userGenero" style="display:none;"></span>
        <div style="display:flex;align-items:center;gap:1em;">
          <div id="userAvatar" style="width:68px;height:68px;border-radius:50%;background:#faf7fd;border:2px solid #8f4be9;display:flex;align-items:center;justify-content:center;font-size:2em;color:#8f4be9;font-weight:600;">AS</div>
          <div>
            <div style="font-size:1.18em;color:#ff69b4;font-weight:600;" id="userName">carregando...</div>
            <div style="font-size:1em;color:#222;" id="userEmail">carregando...</div>
            <div style="font-size:0.98em;color:#222;"><b>Aniversário:</b> <span id="userBirthday">carregando...</span></div>
          </div>
        </div>
        <div style="flex:1;min-width:220px;max-width:380px;display:flex;flex-direction:column;gap:0.3em;">
          <div style="font-size:1em;color:#222;"><b>CPF:</b> <span id="userCPF">carregando...</span></div>
          <div style="font-size:1em;color:#222;"><b>Telefone:</b> <span id="userPhone">carregando...</span></div>
        </div>
        <div style="display:flex;align-items:center;gap:0.5em;">
          <button id="editUserData" style="display:flex;align-items:center;gap:0.7em;background:transparent;border:none;cursor:pointer;padding:0;outline:none;">
            <span style="color:#ff69b4;font-size:1.13em;font-weight:600;font-family:'Poppins',sans-serif;">Alterar Dados</span>
            <span style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:#faf7fd;border-radius:50%;box-shadow:0 1px 4px #ff69b41a;">
              <i class="fa-regular fa-pen-to-square" style="color:#444;font-size:1.18em;"></i>
            </span>
          </button>
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('editUserData');
            if (btn) {
              btn.onclick = async function(e) {
                e.preventDefault();
                // Buscar dados atuais dos campos
                const nome = document.getElementById('userName')?.textContent?.split(' ')[0] || '';
                const sobrenome = document.getElementById('userName')?.textContent?.split(' ').slice(1).join(' ') || '';
                const email = document.getElementById('userEmail')?.textContent || '';
                const cpf = document.getElementById('userCPF')?.textContent || '';
                const dataNascimento = document.getElementById('userBirthday')?.textContent || '';
                const celular = document.getElementById('userPhone')?.textContent || '';
                // Buscar gênero salvo do Firestore (se disponível)
                let genero = '-';
                try {
                  // Busca valor do DOM (populado pelo carregarDadosUsuario)
                  genero = document.getElementById('userGenero')?.textContent || '-';
                } catch {}
                if (!genero || genero === '-') {
                  genero = 'Masculino'; // fallback
                }
                // Montar HTML do formulário
                const html = `
  <form id='formEditarDados' style='text-align:left;max-width:540px;margin:0 auto;'>
    <div style='display:flex;gap:1.3em;'>
      <div style='flex:1;'>
        <label style='color:#b8b8b8;font-size:0.97em;'>Email :</label>
        <input type='email' value='${email}' disabled style='width:100%;background:#f6f6f6;border:1px solid #eee;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
      </div>
      <div style='flex:1;text-align:right;'>
        <a href='#' id='alterarSenhaLink' style='color:#ff69b4;font-weight:600;font-size:0.98em;text-decoration:none;'>ALTERAR SENHA</a>
      </div>
    </div>
    <div id='senhaFields' style='display:none;flex-direction:column;gap:0.7em;margin-bottom:0.6em;'>
      <label style='color:#b8b8b8;font-size:0.97em;'>Nova senha :</label>
      <input id='editSenha' type='password' placeholder='Nova senha' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;font-size:1em;'>
      <label style='color:#b8b8b8;font-size:0.97em;'>Confirme a nova senha :</label>
      <input id='editSenhaConfirma' type='password' placeholder='Confirme a nova senha' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;font-size:1em;'>
    </div>
                    <div style='display:flex;gap:1em;'>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Nome :</label>
                        <input id='editNome' type='text' value='${nome}' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Sobrenome :</label>
                        <input id='editSobrenome' type='text' value='${sobrenome}' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                    </div>
                    <div style='display:flex;gap:1em;'>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Apelido :</label>
                        <input id='editApelido' type='text' placeholder='' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Com qual gênero você se identifica?</label>
                        <div style='display:flex;gap:1em;align-items:center;margin-bottom:0.7em;'>
                          <label style='font-weight:500;color:#ff69b4;'><input type='radio' name='editGenero' value='Feminino' style='accent-color:#ff69b4;' ${genero==='Feminino'?'checked':''}> Feminino</label>
                          <label style='font-weight:500;color:#ff69b4;'><input type='radio' name='editGenero' value='Masculino' style='accent-color:#ff69b4;' ${genero==='Masculino'?'checked':''}> Masculino</label>
                        </div>
                      </div>
                    </div>
                    <div style='display:flex;gap:1em;'>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>CPF :</label>
                        <input type='text' value='${cpf}' disabled style='width:100%;background:#f6f6f6;border:1px solid #eee;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Data de Nascimento :</label>
                        <input id='editDataNascimento' type='text' value='${dataNascimento}' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                    </div>
                    <div style='display:flex;gap:1em;'>
                      <div style='flex:1;'>
                        <label style='color:#b8b8b8;font-size:0.97em;'>Celular :</label>
                        <input id='editCelular' type='text' value='${celular}' style='width:100%;border:1.5px solid #ffb6d5;border-radius:6px;padding:0.7em 1em;margin-bottom:0.7em;font-size:1em;'>
                      </div>
                    </div>
                    <div style='display:flex;gap:1em;'>
                      <label style='font-weight:400;font-size:0.97em;'><input type='checkbox' style='accent-color:#ff69b4;margin-right:0.5em;'> Acompanhar meus pedidos por WhatsApp</label>
                      <label style='font-weight:400;font-size:0.97em;'><input type='checkbox' checked style='accent-color:#ff69b4;margin-right:0.5em;'> Desejo receber promoções e novidades</label>
                    </div>
                  </form>
                `;
                const result = await Swal.fire({
  title: '<span style="color:#ff69b4;font-family:Poppins,sans-serif;font-size:1.5em;font-weight:600;">Editar dados pessoais</span>',
  html: html,
  showCancelButton: true,
  confirmButtonText: 'Salvar Alterações',
  cancelButtonText: 'Cancelar',
  customClass: {
    popup: 'swal2-edit-dados-modal'
  },
  focusConfirm: false,
  width: 650,
  didOpen: () => {
    const link = document.getElementById('alterarSenhaLink');
    if (link) {
      link.onclick = function(ev) {
        ev.preventDefault();
        const senhaFields = document.getElementById('senhaFields');
        if (senhaFields) {
          senhaFields.style.display = senhaFields.style.display === 'none' ? 'flex' : 'none';
          if (senhaFields.style.display === 'flex') {
            document.getElementById('editSenha').focus();
          }
        }
      };
    }
  },
  preConfirm: () => {
                    // Captura os dados do formulário
                    const nome = document.getElementById('editNome').value.trim();
                    const sobrenome = document.getElementById('editSobrenome').value.trim();
                    const apelido = document.getElementById('editApelido').value.trim();
                    const dataNascimento = document.getElementById('editDataNascimento').value.trim();
                    const celular = document.getElementById('editCelular').value.trim();
                    const genero = document.querySelector('input[name="editGenero"]:checked')?.value || '';
                    const senha = document.getElementById('editSenha')?.value || '';
const senhaConfirma = document.getElementById('editSenhaConfirma')?.value || '';
return { nome, sobrenome, apelido, dataNascimento, celular, genero, senha, senhaConfirma };
                  }
                });

                // Evento do link de senha agora é anexado pelo didOpen do Swal.fire

                if (result.isConfirmed && result.value) {
                  // Atualizar Firestore
                  try {
                    // Buscar CPF completo do localStorage
                    const userCPF = localStorage.getItem('essenzaUserCPF');
                    if (!userCPF || userCPF.length < 11) throw new Error('CPF completo não encontrado. Faça login novamente.');
                    await db.collection('clientes').doc(userCPF).update({
                      nome: result.value.nome,
                      sobrenome: result.value.sobrenome,
                      apelido: result.value.apelido,
                      dataNascimento: result.value.dataNascimento,
                      celular: result.value.celular,
                      genero: result.value.genero
                    });
                    // Atualizar campos na tela
                    document.getElementById('userName').textContent = result.value.nome + ' ' + result.value.sobrenome;
                    document.getElementById('userBirthday').textContent = result.value.dataNascimento;
                    document.getElementById('userPhone').textContent = result.value.celular;
                    // Atualizar campo oculto de gênero imediatamente
                    if (document.getElementById('userGenero')) {
                      document.getElementById('userGenero').textContent = result.value.genero;
                    }
                    // Mensagem de sucesso
                    await Swal.fire({
                      icon: 'success',
                      title: 'Dados atualizados!',
                      text: 'Seus dados foram salvos com sucesso.',
                      confirmButtonColor: '#ff69b4',
                      timer: 1800
                    });
                  } catch (err) {
                    await Swal.fire({
                      icon: 'error',
                      title: 'Erro ao salvar',
                      text: err.message || 'Ocorreu um erro ao atualizar seus dados. Tente novamente.',
                      confirmButtonColor: '#ff69b4'
                    });
                  }
                }
              }
            }
          });
          </script>
        </div>
      </div>
      <h2 style="font-family:'Poppins',sans-serif;color:#ff69b4;font-size:2em;font-weight:700;margin-bottom:0.7em;text-align:center;">Endereços</h2>
      <div class="account-address-box" style="background:#fff;border-radius:12px;box-shadow:0 2px 16px #ff69b41a;padding:2em 1em 1.2em 1em;display:flex;justify-content:center;align-items:center;max-width:980px;margin:0 auto;">
        <button id="addAddressBtn" style="display:flex;flex-direction:column;align-items:center;gap:0.7em;background:transparent;border:none;cursor:pointer;outline:none;">
          <span style="display:flex;align-items:center;justify-content:center;width:58px;height:58px;background:#faf7fd;border-radius:50%;box-shadow:0 2px 8px #ff69b41a;">
            <i class="fa-solid fa-plus" style="color:#ff69b4;font-size:2em;"></i>
          </span>
          <span style="font-size:1.09em;color:#222;font-weight:500;">Adicionar novo endereço</span>
        </button>
      </div>
    </section>
    <section id="sectionPedidos" class="account-section" style="display:none">
      <h2 style="font-family:'Poppins',sans-serif;color:#ff69b4;font-size:2.1em;font-weight:700;margin-bottom:0.7em;text-align:center;">Meus Pedidos</h2>
      <div class="account-data-box" style="background:#fff;border-radius:12px;box-shadow:0 2px 16px #ff69b41a;padding:2em 1.2em;max-width:980px;margin:0 auto 2em auto;display:flex;align-items:center;justify-content:center;">
        <span style="color:#888;font-size:1.13em;">Em breve você verá seus pedidos aqui.</span>
      </div>
    </section>
    <section id="sectionFavoritos" class="account-section" style="display:none">
      <h2 style="font-family:'Poppins',sans-serif;color:#ff69b4;font-size:2.1em;font-weight:700;margin-bottom:0.7em;text-align:center;">Favoritos</h2>
      <div class="account-data-box" style="background:#fff;border-radius:12px;box-shadow:0 2px 16px #ff69b41a;padding:2em 1.2em;max-width:980px;margin:0 auto 2em auto;display:flex;align-items:center;justify-content:center;">
        <span style="color:#888;font-size:1.13em;">Em breve você verá seus favoritos aqui.</span>
      </div>
    </section>
    <div class="account-actions" style="max-width:980px;margin:2.5em auto 0 auto;">
      <button class="account-action-btn logout" id="logoutBtn"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</button>
    </div>
  </main>
  <style>
    .account-tab-btn {
      border:none;background:#ff69b4;color:#fff;padding:1.1em 2.4em;font-size:1.18em;font-family:'Poppins',sans-serif;font-weight:600;border-radius:13px;box-shadow:0 2px 10px #ff69b430;transition:background .18s, color .17s, box-shadow .18s;cursor:pointer;outline:none;margin:0;}
    .account-tab-btn.active, .account-tab-btn:focus {background:#8f4be9!important;color:#fff!important;box-shadow:0 2px 16px #8f4be930!important;}
    .account-tab-btn:not(.active):hover {background:#ff85c2;color:#fff;box-shadow:0 2px 16px #ffb6d5a0;}
    .account-data-box, .account-address-box {
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 900px) {
      .account-data-box, .account-address-box {
        max-width: 98vw;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
    }
    @media (max-width: 700px) {
      .account-tabs {
        flex-direction: column;
        gap: 0.5em;
        margin-bottom: 1.1em;
      }
      .account-tab-btn {
        width: 100%;
        padding: 0.85em 0.5em;
        font-size: 1em;
      }
      .account-data-box, .account-address-box {
        flex-direction: column;
        gap: 1.1em;
        padding: 1.1em 0.7em 1.1em 0.7em;
        align-items: flex-start;
      }
      .account-data-box > div, .account-address-box > div {
        width: 100%!important;
        min-width: unset!important;
        max-width: unset!important;
        justify-content: flex-start!important;
        text-align: left!important;
      }
      #userAvatar {
        margin: 0 auto 0.7em auto;
        width: 54px!important;
        height: 54px!important;
        font-size: 1.3em!important;
      }
    }
    @media (max-width: 480px) {
      .account-data-box, .account-address-box {
        padding: 0.7em 0.3em 0.8em 0.3em;
        border-radius: 8px;
      }
      h2 {
        font-size: 1.18em!important;
      }
      .account-tab-btn {
        font-size: 0.98em;
        padding: 0.7em 0.2em;
      }
    }
  </style>
  <script>
    function showSection(tab) {
      document.getElementById('sectionDados').style.display = tab === 'dados' ? '' : 'none';
      document.getElementById('sectionPedidos').style.display = tab === 'meus-pedidos' ? '' : 'none';
      document.getElementById('sectionFavoritos').style.display = tab === 'favoritos' ? '' : 'none';
      document.getElementById('tabDadosBtn').style.background = tab === 'dados' ? '#8f4be9' : '#ff69b4';
      document.getElementById('tabPedidosBtn').style.background = tab === 'meus-pedidos' ? '#8f4be9' : '#ff69b4';
      document.getElementById('tabFavoritosBtn').style.background = tab === 'favoritos' ? '#8f4be9' : '#ff69b4';
    }
    function getTabFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('aba') || 'dados';
    }
    function setTab(tab) {
      const url = tab === 'dados' ? 'minha-conta.html' : `minha-conta.html?aba=${tab}`;
      window.history.replaceState({}, '', url);
      showSection(tab);
    }
    document.getElementById('tabDadosBtn').onclick = () => setTab('dados');
    document.getElementById('tabPedidosBtn').onclick = () => setTab('meus-pedidos');
    document.getElementById('tabFavoritosBtn').onclick = () => setTab('favoritos');
    showSection(getTabFromUrl());

    // Carregar dados do cliente do Firestore
    document.addEventListener('DOMContentLoaded', function() {
       async function carregarDadosUsuario(user) {
         console.log('[Essenza] Usuário autenticado:', user);
         if (user) {
          // Tenta obter CPF do localStorage (gravado no cadastro)
           let cpf = localStorage.getItem('essenzaUserCPF');
           console.log('[Essenza] CPF do localStorage:', cpf);
          let clienteDoc = null;
           if (cpf) {
             clienteDoc = await db.collection('clientes').doc(cpf).get();
             console.log('[Essenza] Documento Firestore por CPF:', clienteDoc);
           } else {
             // Se não tem CPF salvo, tenta buscar pelo e-mail
             const snap = await db.collection('clientes').where('email', '==', user.email).get();
             console.log('[Essenza] Snap Firestore por email:', snap);
             if (!snap.empty) {
               clienteDoc = snap.docs[0];
               cpf = clienteDoc.id;
               localStorage.setItem('essenzaUserCPF', cpf);
             }
           }
           if (clienteDoc && clienteDoc.exists) {
             console.log('[Essenza] Dados carregados do Firestore:', clienteDoc.data());
            const dados = clienteDoc.data();
            // Nome completo: prioriza Firestore, depois Google
            let nomeCompleto = '';
            if (dados.nome && dados.sobrenome) {
              nomeCompleto = dados.nome + ' ' + dados.sobrenome;
            } else if (dados.nome) {
              nomeCompleto = dados.nome;
            } else if (user.displayName) {
              nomeCompleto = user.displayName;
            } else {
              nomeCompleto = user.email;
            }
            document.getElementById('userName').textContent = nomeCompleto;
            document.getElementById('userEmail').textContent = dados.email || user.email;
            let cpfExibir = (dados.cpf || cpf || '').replace(/\D/g, '');
             document.getElementById('userCPF').textContent = cpfExibir && cpfExibir.length === 11 ? `${cpfExibir.substr(0,3)}.***.***-**` : '-';
            document.getElementById('userPhone').textContent = dados.celular || '-';
            document.getElementById('userBirthday').textContent = dados.dataNascimento || '-';
            // Avatar com iniciais
            let iniciais = nomeCompleto.split(' ').map(p => p[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('userAvatar').textContent = iniciais;
            // Preencher campo oculto de gênero
            if (document.getElementById('userGenero')) {
              console.log('[Essenza][DEBUG] Valor de gênero vindo do Firestore:', dados.genero);
              document.getElementById('userGenero').textContent = dados.genero || '-';
              console.log('[Essenza][DEBUG] Valor de gênero no DOM após setar:', document.getElementById('userGenero').textContent);
            }
          } else {
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userCPF').textContent = '-';
            document.getElementById('userPhone').textContent = '-';
            document.getElementById('userBirthday').textContent = '-';
            document.getElementById('userAvatar').textContent = (user.displayName||user.email).substring(0,2).toUpperCase();
            // Mensagem para completar cadastro
            Swal.fire({
              icon: 'warning',
              title: 'Complete seu cadastro',
              text: 'Para acessar todos os recursos, preencha seu CPF, celular e data de nascimento.',
              confirmButtonColor: '#ff69b4',
              confirmButtonText: 'Ok'
            });
          }
         }
       }
       auth.onAuthStateChanged(carregarDadosUsuario);
    });
  </script>
  <script src="js/config.js"></script>
  <script>
    // Usa window.db e window.auth definidos em config.js
    const db = window.db;
    const auth = window.auth;

    // Proteção de acesso: só entra autenticado
    function redirectToLogin() {
      window.location.href = 'login.html';
    }
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Tenta localStorage (caso login por email/senha)
        const local = localStorage.getItem('essenzaUser');
        if (!local) return redirectToLogin();
        const data = JSON.parse(local);
        document.getElementById('userName').textContent = data.name || '-';
        document.getElementById('userEmail').textContent = data.email || '-';
        // Buscar CPF do Firestore
        try {
          const snap = await db.collection('clientes').where('email','==',data.email).limit(1).get();
          if (!snap.empty) {
            document.getElementById('userCPF').textContent = snap.docs[0].data().cpf || '-';
          } else {
            document.getElementById('userCPF').textContent = '-';
          }
        } catch {
          document.getElementById('userCPF').textContent = '-';
        }
      } else {
        document.getElementById('userName').textContent = user.displayName || '-';
        document.getElementById('userEmail').textContent = user.email || '-';
        // Buscar CPF do Firestore
        try {
          const snap = await db.collection('clientes').where('email','==',user.email).limit(1).get();
          if (!snap.empty) {
            document.getElementById('userCPF').textContent = snap.docs[0].data().cpf || '-';
          } else {
            document.getElementById('userCPF').textContent = '-';
          }
        } catch {
          document.getElementById('userCPF').textContent = '-';
        }
      }
    });
    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      await auth.signOut();
      localStorage.removeItem('essenzaUser');
      window.location.href = 'login.html';
    };
  </script>

  <script type="module">
    import { loadProducts } from './js/products.js';
    import { renderPedidosConta } from './js/render-pedidos.js';
    import './js/render-favoritos.js';
    window.products = [];
    loadProducts().then(() => {
      if (window.renderFavoritosConta) window.renderFavoritosConta();
      if (window.renderPedidosConta) window.renderPedidosConta();
    });
</script>
</html>
