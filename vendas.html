<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Tela de Venda Rápida</title>
  <style>
    :root{
      --bg:#0e0f12;         /* fundo escuro elegante */
      --card:#151821;       /* cartões */
      --muted:#252a36;      /* bordas/inputs */
      --text:#e8ecf2;       /* texto principal */
      --sub:#a7b0c3;        /* texto secundário */
      --brand:#6dd17c;      /* destaque/CTA */
      --danger:#ff6363;     /* remover/erro */
      --warn:#ffb86b;       /* alerta */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; color:var(--text);
      background:linear-gradient(180deg,#0b0c10, #0e0f12 8%, #0e0f12);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      background:rgba(14,15,18,.75); border-bottom:1px solid var(--muted);
    }
    .container{padding:16px; max-width:900px; margin:0 auto}
    .row{display:flex; gap:12px}
    .col{flex:1}
    h1{font-size:20px; margin:10px 0}

    /* Busca */
    .search-card{background:var(--card); border:1px solid var(--muted); padding:12px; border-radius:14px}
    .search-wrap{display:flex; gap:8px}
    .input{flex:1; background:#0f1116; color:var(--text); border:1px solid var(--muted); border-radius:12px; padding:14px 12px; outline:none}
    .input::placeholder{color:#7d879a}
    .btn{appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:600; cursor:pointer}
    .btn-brand{background:var(--brand); color:#0a0d10}
    .btn-ghost{background:#0f1116; color:var(--text); border:1px solid var(--muted)}
    .btn-danger{background:var(--danger); color:#0a0d10}
    .btn-sm{padding:8px 10px; border-radius:10px; font-size:14px}

    /* Lista de produtos */
    .list{margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height:38vh; overflow:auto}
    .item{display:flex; gap:10px; align-items:center; background:#10131a; border:1px solid var(--muted); padding:10px; border-radius:12px}
    .avatar{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#2f3544,#3c4356); display:grid; place-items:center; font-weight:700; color:#dfe7ff}
    .item .meta{flex:1}
    .item .title{font-size:15px; font-weight:700}
    .item .sub{font-size:12px; color:var(--sub)}
    .price{font-weight:800}

    /* Carrinho */
    .card{background:var(--card); border:1px solid var(--muted); padding:12px; border-radius:14px}
    .cart-list{display:flex; flex-direction:column; gap:8px; max-height:26vh; overflow:auto}
    .cart-row{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; background:#10131a; border:1px solid var(--muted); border-radius:12px; padding:10px}
    .qty{display:flex; align-items:center; gap:6px}
    .qty .btn{width:34px; height:34px}
    .qty input{width:54px; text-align:center; padding:8px; border-radius:10px; border:1px solid var(--muted); background:#0f1116; color:var(--text)}
    .line-right{display:flex; align-items:center; gap:8px}

    /* Cliente & Pagamento */
    .form{display:grid; gap:8px}
    label{font-size:12px; color:var(--sub)}
    .row-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--muted); padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none}
    .chip.active{background:var(--brand); color:#0a0d10; border-color:transparent}

    /* Barra fixa */
    .bar{position:fixed; left:0; right:0; bottom:0; background:rgba(15,16,20,.95); border-top:1px solid var(--muted); padding:12px; z-index:20}
    .bar .inner{max-width:900px; margin:0 auto; display:flex; gap:10px; align-items:center}
    .total{font-size:18px; font-weight:800; margin-right:auto}

    /* Toast/Modal simples */
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:80px; background:#111520; border:1px solid var(--muted); padding:12px 14px; border-radius:12px; display:none; z-index:30}

    /* Espaço inferior para não ficar atrás da barra */
    .spacer{height:96px}

    @media(min-width:720px){
      .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
      .list{max-height:50vh}
      .cart-list{max-height:32vh}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="img/logo.png" alt="Logo Essenza" style="height:42px; width:auto; filter: drop-shadow(0 1px 2px #0002);">
        <h1 style="margin:0; font-family: 'Playfair Display', serif; font-weight:600; letter-spacing:1px; font-size:2.1rem; color:#f3e8e2; text-shadow:0 1px 6px #0006;">ESSENZA</h1>
        <span style="margin-left:18px; font-size:1.23rem; font-family:'Poppins',sans-serif; color:#fff; font-weight:400; letter-spacing:0.5px; opacity:0.85;">Venda Rápida</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- BUSCA / PRODUTOS -->
    <section class="search-card">
      <div class="search-wrap">
        <input id="q" class="input" placeholder="Buscar por nome, código ou código de barras..." autocomplete="off" />
        <button id="clearFilter" class="btn btn-ghost" type="button">Limpar Filtro</button>
      </div>
      <div id="results" class="list" aria-live="polite"></div>
    </section>

    <div class="grid" style="margin-top:12px">
      <!-- CARRINHO -->
      <section class="card">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
          <strong>Carrinho</strong>
          <span id="cartCount" class="sub"></span>
        </div>
        <div id="cartList" class="cart-list" aria-live="polite"></div>
      </section>

      <!-- CLIENTE / PAGAMENTO -->
      <section class="card">
        <strong style="display:block; margin-bottom:6px">Cliente & Pagamento</strong>
        <form id="orderForm" class="form" autocomplete="off">
          <div>
            <label for="nome">Nome completo *</label>
            <input id="nome" class="input" required placeholder="Ex: Maria Silva" />
          </div>
          <div class="row-2">
            <div>
              <label for="cel">Celular (com DDD) *</label>
              <input id="cel" class="input" required inputmode="tel" placeholder="(11) 90000-0000" />
            </div>
            <div>
              <label for="email">E-mail (opcional)</label>
              <input id="email" class="input" type="email" placeholder="email@exemplo.com" />
            </div>
          </div>

          <div>
            <label for="couponInput">Cupom de desconto</label>
            <div style="display:flex; gap:0.5em; align-items:center; margin-bottom:0.3em;">
              <input type="text" id="couponInput" class="input" placeholder="Cupom de desconto" style="flex:1;max-width:170px;">
              <button type="button" id="clearCouponBtn" style="display:none;margin-left:-32px;background:transparent;border:none;color:#888;font-size:1.2rem;cursor:pointer;align-self:center;" aria-label="Limpar cupom">&times;</button>
              <button type="button" id="applyCouponBtn" class="btn btn-ghost btn-sm">Aplicar</button>
            </div>
            <div id="couponFeedback" class="coupon-feedback" style="margin-bottom:0.7em;"></div>
          </div>

          <div>
            <label>Forma de pagamento</label>
            <div id="payChips" class="chips" style="gap:0.7em;">
              <label class="chip payment-option">
                <input type="radio" name="paymentMethod" id="paymentMethodPix" value="pix" checked style="display:none;">
                <span><i class="fas fa-bolt"></i> PIX <span class="discount-badge" id="pixDiscountBadge" style="font-size:11px; margin-left:2px;">-10%</span></span>
              </label>
              <label class="chip payment-option">
                <input type="radio" name="paymentMethod" id="paymentMethodCredit" value="credit" style="display:none;">
                <span><i class="far fa-credit-card"></i> Crédito</span>
              </label>
              <label class="chip payment-option" id="acordoChip" style="display:none;">
                <input type="radio" name="paymentMethod" id="paymentMethodAgreement" value="agreement" style="display:none;">
                <span><i class="fas fa-file-signature"></i> Acordo</span>
              </label>
            </div>
          </div>

          <div id="installmentsWrap" style="display:none;">
            <label for="installments">Parcelar em:</label>
            <select id="installments" class="input"></select>
            <div id="installmentInfo" style="color:#a7b0c3;font-size:13px;margin-top:2px;"></div>
          </div>

          <div id="cashWrap" style="display:none">
            <div class="row-2">
              <div>
                <label for="valorRecebido">Valor recebido (R$)</label>
                <input id="valorRecebido" class="input" inputmode="decimal" placeholder="0,00" />
              </div>
              <div>
                <label>Troco</label>
                <div id="troco" class="input" style="display:flex; align-items:center; font-weight:700">R$ 0,00</div>
              </div>
            </div>
          </div>
        </form>
      </section>
    </div>

    <div class="spacer"></div>
  </main>

  <!-- BARRA FIXA -->
  <div class="bar">
    <div class="inner">
      <div class="total">Total: <span id="total">R$ 0,00</span></div>
      <button id="shareWA" class="btn btn-ghost btn-sm" title="Compartilhar no WhatsApp">Compartilhar</button>
      <button id="finish" class="btn btn-brand">Encerrar Pedido</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module" src="js/vendas.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';
    // Inicializar Firebase e Firestore para uso dos módulos ES6
    const firebaseConfig = {
      apiKey: "AIzaSyAxwRPEkFUE_rudNjKT7xrg5lSLfTHUe-g",
      authDomain: "siteabel-4bcca.firebaseapp.com",
      projectId: "siteabel-4bcca",
      storageBucket: "siteabel-4bcca.appspot.com",
      messagingSenderId: "865433569180",
      appId: "1:865433569180:web:2ad4d6391ad2432b25aa59",
      measurementId: "G-PDFHYJ6YZK"
    };
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);

    // ===================== UTILS =====================
    const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatBRL = (n)=> BRL.format(n || 0);
    const parseBRL = (s)=>{
      if(!s) return 0; // aceita 0
      // converte "1.234,56" -> 1234.56
      const only = String(s).replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(',','.');
      const n = parseFloat(only);
      return isNaN(n) ? 0 : n;
    };
    const el = (sel)=> document.querySelector(sel);
    const uid = ()=> 'P'+Date.now().toString(36)+Math.random().toString(36).slice(2,6).toUpperCase();

    // ===================== FIRESTORE INTEGRATION =====================
    import { loadProducts, baixarEstoque, salvarPedidoFirestore } from './js/vendas-firestore.js';
    let products = [];
    let cart = [];
    // Carregar produtos reais ao iniciar
    window.addEventListener('DOMContentLoaded', async () => {
      products = await loadProducts();
      renderList('');
    });
    function saveProducts(list){ localStorage.setItem(STORAGE_PRODUCTS, JSON.stringify(list)); }

    function loadOrders(){
      const saved = localStorage.getItem(STORAGE_ORDERS);
      return saved ? JSON.parse(saved) : [];
    }
    function saveOrders(list){ localStorage.setItem(STORAGE_ORDERS, JSON.stringify(list)); }

    // products já é carregado de Firestore acima
    // cart = [] já definido acima

    // ===================== RENDER BUSCA =====================
    const results = el('#results');
    function initials(name){
      const parts = name.split(' ').filter(Boolean);
      const a = parts[0]?.[0]||''; const b = parts[1]?.[0]||'';
      return (a+b).toUpperCase() || 'PR';
    }
    function renderList(q=''){
      q = q.trim().toLowerCase();
      results.innerHTML = '';
      const items = products.filter(p=> !q || p.nome.toLowerCase().includes(q) || p.codigo.toLowerCase().includes(q) || p.id.includes(q));
      if(items.length===0){
        results.innerHTML = `<div class="sub">Nenhum produto encontrado.</div>`;
        return;
      }
      for(const p of items){
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="avatar" style="padding:0">
            ${p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.nome}" style="width:44px;height:44px;object-fit:cover;border-radius:10px;">` : initials(p.nome)}
          </div>
          <div class="meta">
            <div class="title">${p.nome}</div>
            ${(() => {
  if (!p.descricao) return '';
  const matches = [...p.descricao.matchAll(/\*\*(.*?)\*\*/g)];
  if (!matches.length) return '';
  return `<div class='desc' style='color:#e8ecf2;font-size:13px;margin-top:2px;'>${matches.map(m => m[1]).join(' • ')}</div>`;
})()}

            <div class="sub">Código: ${p.id} • Estoque: <strong>${p.estoque}</strong></div>
          </div>
          <div class="price" style="display:flex;flex-direction:column;align-items:flex-end;min-width:120px;">
            ${p.oldPrice && p.oldPrice > p.preco ? `<span style='color:#a7b0c3;text-decoration:line-through;font-size:13px;'>${formatBRL(p.oldPrice)}</span>` : ''}
            <span style='font-weight:800;font-size:17px;'>${formatBRL(p.preco)}</span>
            ${p.precoPix && p.precoPix < p.preco ? `<span style='color:#6dd17c;font-size:13px;'>PIX ${formatBRL(p.precoPix)}</span>` : ''}
          </div>
          <button class="btn btn-brand btn-sm">+</button>
        `;
        const btn = row.querySelector('button');
        btn.addEventListener('click', ()=> addToCart(p.id));
        results.appendChild(row);
      }
    }

    // ===================== CARRINHO =====================
    function addToCart(id){
      const p = products.find(x=>x.id===id);
      if(!p) return;
      if(p.estoque<=0){ toast('Produto sem estoque'); return; }
      const item = cart.find(x=>x.id===id);
      if(item){
        if(item.qty+1 > p.estoque){ toast('Quantidade excede o estoque'); return; }
        item.qty++;
      } else {
        cart.push({id:p.id, nome:p.nome, preco:p.preco, precoPix:p.precoPix, qty:1});
      }
      renderCart();
    }

    function removeFromCart(id){
      cart = cart.filter(x=>x.id!==id);
      renderCart();
    }

    function setQty(id, qty){
      qty = Math.max(1, Math.floor(qty||1));
      const p = products.find(x=>x.id===id);
      const item = cart.find(x=>x.id===id);
      if(!item || !p) return;
      if(qty > p.estoque){ toast('Quantidade excede o estoque'); return; }
      item.qty = qty; renderCart();
    }

    function getItemPrice(p) {
      if (formaSelecionada === 'Crédito') return p.preco;
      if (formaSelecionada === 'Pix' || formaSelecionada === 'Dinheiro' || formaSelecionada === 'Débito') return p.precoPix && p.precoPix < p.preco ? p.precoPix : p.preco;
      return p.preco;
    }
    function cartTotal(){
      return cart.reduce((s,x)=> {
        const p = products.find(prod=>prod.id===x.id);
        return s + (p ? getItemPrice(p) * x.qty : 0);
      }, 0);
    }

    function renderCart(){
      const list = el('#cartList');
      list.innerHTML = '';
      el('#cartCount').textContent = cart.length ? `(${cart.length} item${cart.length>1?'s':''})` : '(vazio)';
      for(const it of cart){
        const p = products.find(x=>x.id===it.id);
        const valor = p ? getItemPrice(p) : it.preco;
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${it.nome}</div>
            <div class="sub">${formatBRL(valor)} • Estoque: ${p?.estoque ?? 0}</div>
          </div>
          <div class="line-right">
            <div class="qty">
              <button class="btn btn-ghost" aria-label="Diminuir">−</button>
              <input value="${it.qty}" aria-label="Quantidade" />
              <button class="btn btn-ghost" aria-label="Aumentar">+</button>
            </div>
            <div style="width:90px; text-align:right; font-weight:800">${formatBRL(valor * it.qty)}</div>
            <button class="btn btn-danger" title="Remover">✕</button>
          </div>
        `;
        const [btnMenos, inputQty, btnMais] = row.querySelectorAll('.qty > *');
        const btnRem = row.querySelector('.btn-danger');
        btnMenos.addEventListener('click', ()=> setQty(it.id, it.qty-1));
        btnMais.addEventListener('click', ()=> setQty(it.id, it.qty+1));
        inputQty.addEventListener('change', (e)=> setQty(it.id, parseInt(e.target.value,10)||1));
        btnRem.addEventListener('click', ()=> removeFromCart(it.id));
        list.appendChild(row);
      }
      el('#total').textContent = formatBRL(cartTotal());
      updateTroco();
    }

    // ===================== PAGAMENTO =====================
    // Formas de pagamento dinâmicas: 'Acordo' só aparece se cupom permitir acordo
    function getFormasPagamento() {
      // O cupom aplicado é exposto globalmente por vendas.js
      if (window.getAppliedCoupon && window.getAppliedCoupon() && window.getAppliedCoupon().enableAgreement) {
        return ['Dinheiro','Pix','Crédito','Débito','Acordo'];
      }
      return ['Dinheiro','Pix','Crédito','Débito'];
    }
    let formaSelecionada = 'Pix';

    function renderPayChips(){
      const wrap = el('#payChips');
      wrap.innerHTML = '';
      const formas = getFormasPagamento();
      // Se a forma selecionada não está mais disponível, volta para Pix
      if (!formas.includes(formaSelecionada)) formaSelecionada = 'Pix';
      for(const f of formas){
        const chip = document.createElement('div');
        chip.className = 'chip'+(f===formaSelecionada?' active':'');
        chip.textContent = f;
        chip.tabIndex = 0;
        chip.addEventListener('click', () => { formaSelecionada = f; renderPayChips(); toggleCash(); renderCart(); renderList(el('#q').value); });
        chip.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); chip.click(); }});
        wrap.appendChild(chip);
      }
      // Atualiza exibição do chip visual "Acordo"
      if (window.updateAcordoVisibility) window.updateAcordoVisibility();
      if (window.renderPayChips) window.renderPayChips();
      updateCartTotals();
    }

    function toggleCash(){
      const cash = el('#cashWrap');
      if(formaSelecionada==='Dinheiro') cash.style.display='block'; else cash.style.display='none';
      updateTroco();
    }

    function updateTroco(){
      const total = cartTotal();
      const recebido = parseBRL(el('#valorRecebido')?.value);
      const troco = Math.max(0, (formaSelecionada==='Dinheiro') ? (recebido - total) : 0);
      el('#troco').textContent = formatBRL(troco);
    }

    // ===================== FINALIZAR =====================
    function validate(){
      if(cart.length===0){ toast('Adicione itens ao carrinho'); return false; }
      const nome = el('#nome').value.trim();
      const cel = el('#cel').value.trim();
      if(!nome){ toast('Informe o nome completo'); return false; }
      if(!cel){ toast('Informe o celular'); return false; }
      if(formaSelecionada==='Dinheiro'){
        const recebido = parseBRL(el('#valorRecebido').value);
        if(recebido < cartTotal()){ toast('Valor recebido insuficiente'); return false; }
      }
      // checa estoque
      for(const it of cart){
        const p = products.find(x=>x.id===it.id);
        if(!p || it.qty > p.estoque){ toast('Estoque insuficiente para '+it.nome); return false; }
      }
      return true;
    }

    async function lowerStock(){
      for(const it of cart){
        await baixarEstoque(it.id, it.qty);
        // Atualiza localmente para feedback imediato
        const p = products.find(x=>x.id===it.id);
        if(p) p.estoque -= it.qty;
      }
    }

    async function finalize(){
      if(!validate()) return;
      const order = {
        id: uid(),
        data: new Date().toISOString(),
        itens: cart.map(it=> ({ id:it.id, nome:it.nome, qtd:it.qty, preco:it.preco, subtotal: +(it.preco*it.qty).toFixed(2) })),
        total: +cartTotal().toFixed(2),
        cliente: {
          nome: el('#nome').value.trim(),
          cel: el('#cel').value.trim(),
          email: el('#email').value.trim()||null
        },
        pagamento: {
          forma: formaSelecionada,
          recebido: formaSelecionada==='Dinheiro' ? parseBRL(el('#valorRecebido').value) : null,
          troco: formaSelecionada==='Dinheiro' ? Math.max(0, parseBRL(el('#valorRecebido').value) - cartTotal()) : 0
        }
      };
      await lowerStock();
      // Opcional: salvar pedido no Firestore
      try { await salvarPedidoFirestore(order); } catch(e){ console.warn('Erro ao salvar pedido no Firestore:', e); }
      toast('Pedido '+order.id+' finalizado com sucesso!');
      // limpar tela
      cart = [];
      el('#orderForm').reset();
      formaSelecionada = 'Pix';
      renderPayChips();
      renderCart();
      renderList(el('#q').value);
      shareWhatsApp(order);
    }

    function shareWhatsApp(order){
      const linhas = [];
      linhas.push('*Pedido:* '+order.id);
      linhas.push('*Data:* '+ new Date(order.data).toLocaleString('pt-BR'));
      linhas.push('*Cliente:* '+order.cliente.nome +' • '+ order.cliente.cel);
      if(order.cliente.email) linhas.push('*E-mail:* '+order.cliente.email);
      linhas.push('');
      for(const it of order.itens){ linhas.push(`- ${it.qtd}x ${it.nome} • ${BRL.format(it.preco)} = ${BRL.format(it.subtotal)}`); }
      linhas.push('');
      linhas.push('*Total:* '+ BRL.format(order.total));
      linhas.push('*Pagamento:* '+ order.pagamento.forma + (order.pagamento.forma==='Dinheiro' ? ` • Recebido: ${BRL.format(order.pagamento.recebido)} • Troco: ${BRL.format(order.pagamento.troco)}` : ''));
      const msg = encodeURIComponent(linhas.join('\n'));
      const url = `https://wa.me/?text=${msg}`;
      window.open(url, '_blank');
    }

    // ===================== TOAST =====================
    let toastTimer;
    function toast(text){
      const t = el('#toast');
      t.textContent = text;
      t.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.display='none'; }, 2600);
    }

    // ===================== EVENTOS =====================
    el('#q').addEventListener('input', e=> renderList(e.target.value));
    el('#finish').addEventListener('click', finalize);
    el('#valorRecebido').addEventListener('input', updateTroco);
    el('#shareWA').addEventListener('click', ()=>{
      const orders = loadOrders();
      const last = orders[orders.length-1];
      if(!last){ toast('Nenhum pedido para compartilhar'); return; }
      shareWhatsApp(last);
    });
    // Limpar filtro de busca
    el('#clearFilter').addEventListener('click', ()=>{
      el('#q').value = '';
      renderList('');
    });

    // ===================== PARCELAMENTO =====================
    function showInstallments(show) {
      el('#installmentsWrap').style.display = show ? '' : 'none';
    }
    function calculateInstallment(total, installments) {
      return total / installments;
    }
    function updateInstallmentOptions() {
      const select = el('#installments');
      if (!select) return;
      let opts = [];
      if (formaSelecionada === 'Crédito') {
        opts = [1,2,3];
      } else if (formaSelecionada === 'Acordo') {
        opts = [1,2];
      } else {
        opts = [1];
      }
      select.innerHTML = opts.map(v => `<option value="${v}">${v}x sem juros</option>`).join('');
      select.value = '1';
    }
    function updateInstallmentInfo() {
      const select = el('#installments');
      if (!select) return;
      const val = parseInt(select.value);
      let total = cartTotal();
      if (isNaN(total) || total <= 0) { el('#installmentInfo').textContent = ''; return; }
      const parcela = calculateInstallment(total, val);
      el('#installmentInfo').textContent = `${val}x de ${formatBRL(parcela)} sem juros`;
    }
    if (el('#installments')) {
      el('#installments').addEventListener('change', () => {
        updateInstallmentInfo();
        renderCart(); // Para atualizar total parcelado
      });
    }

    // =========== INTEGRAÇÃO COM FORMA DE PAGAMENTO ==========
    // Supondo que já existe a variável formaSelecionada e função renderPayChips
    const oldRenderPayChips = renderPayChips;
    renderPayChips = function() {
      oldRenderPayChips();
      showInstallments(formaSelecionada === 'Crédito' || formaSelecionada === 'Acordo');
      updateInstallmentOptions();
      updateInstallmentInfo();
    }
    // Atualizar também ao trocar forma de pagamento
    document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('chip')) {
        setTimeout(()=>{
          showInstallments(formaSelecionada === 'Crédito' || formaSelecionada === 'Acordo');
          updateInstallmentOptions();
          updateInstallmentInfo();
        }, 50);
      }
    });
    // Inicialização
    updateInstallmentOptions();

    // =========== ATUALIZAR O TOTAL CONFORME PARCELAMENTO ==========
    const oldCartTotal = cartTotal;
    cartTotal = function() {
      if (formaSelecionada === 'Crédito' && el('#installments')) {
        const val = parseInt(el('#installments').value);
        let total = oldCartTotal();
        if (val > 6) {
          // Com juros
          return calculateInstallment(total, val) * val;
        }
        return total;
      }
      return oldCartTotal();
    }

    // ===================== INIT =====================
    renderList('');
    renderCart();
    renderPayChips();
    toggleCash();
  </script>
</body>
</html>
